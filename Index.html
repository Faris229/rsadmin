<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN | FIX LOADING</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;400;600;800&family=Prompt:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #020617; color: #fff; overflow-x: hidden; font-family: 'Prompt', sans-serif; }
        .glass-card { background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; backdrop-filter: blur(10px); }
        .input-adm { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid #334155; padding: 12px; border-radius: 10px; color: white; outline: none; }
        .menu-item { display: flex; items-center; gap: 12px; padding: 16px; border-radius: 12px; color: #94a3b8; cursor: pointer; }
        .menu-item.active { background: #4f46e5; color: white; }
        /* Debug Status */
        #status-bar { position: fixed; top: 0; right: 0; padding: 5px 15px; font-size: 12px; font-weight: bold; z-index: 9999; }
        .st-ok { background: #16a34a; color: white; }
        .st-err { background: #dc2626; color: white; }
    </style>
</head>
<body class="flex min-h-screen">

    <div id="status-bar" class="st-err">Connecting...</div>

    <div id="view-login" class="fixed inset-0 z-[200] bg-[#020617] flex items-center justify-center p-6">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-4xl font-bold mb-6 text-blue-500">ADMIN LOGIN</h1>
            <div class="space-y-4 glass-card p-8">
                <input id="a-email" value="faris@gmail.com" class="input-adm text-center" placeholder="Email">
                <input id="a-pass" type="password" class="input-adm text-center" placeholder="Password">
                <button onclick="Admin.login()" class="w-full bg-blue-600 py-3 rounded-xl font-bold">เข้าสู่ระบบ</button>
            </div>
        </div>
    </div>

    <aside class="w-64 bg-slate-900 p-6 flex flex-col hidden" id="sidebar">
        <div class="mb-10 text-xl font-bold text-blue-400">COMMAND CENTER</div>
        <nav class="flex-1 space-y-2">
            <div onclick="UI.tab('dash')" id="tab-dash" class="menu-item active"><i class="fa-solid fa-chart-pie"></i> แดชบอร์ด</div>
            <div onclick="UI.tab('reqs')" id="tab-reqs" class="menu-item"><i class="fa-solid fa-money-bill"></i> ฝาก-ถอน</div>
            <div onclick="UI.tab('rooms')" id="tab-rooms" class="menu-item"><i class="fa-solid fa-gamepad"></i> ห้องเกม</div>
        </nav>
        <button onclick="auth.signOut()" class="bg-red-900/50 text-red-400 py-3 rounded-xl">Logout</button>
    </aside>

    <div class="flex-1 p-8 hidden" id="main-content">
        
        <div class="mb-6 flex justify-end">
            <button onclick="Admin.forceFix()" class="bg-yellow-600 hover:bg-yellow-500 text-white px-6 py-2 rounded-lg font-bold shadow-lg animate-pulse">
                <i class="fa-solid fa-magic mr-2"></i> กดปุ่มนี้ถ้าข้อมูลไม่ขึ้น (สร้างข้อมูล)
            </button>
        </div>

        <div id="page-dash">
            <h1 class="text-3xl font-bold mb-6">ภาพรวม</h1>
            <div class="grid grid-cols-3 gap-6 mb-8">
                <div class="glass-card p-6 border-l-4 border-blue-500">
                    <div class="text-slate-400 text-xs uppercase">Users</div>
                    <div id="stat-users" class="text-3xl font-bold">...</div>
                </div>
                <div class="glass-card p-6 border-l-4 border-yellow-500">
                    <div class="text-slate-400 text-xs uppercase">Pending</div>
                    <div id="stat-pending" class="text-3xl font-bold">...</div>
                </div>
                <div class="glass-card p-6 border-l-4 border-green-500">
                    <div class="text-slate-400 text-xs uppercase">Active Rooms</div>
                    <div id="stat-rooms" class="text-3xl font-bold">...</div>
                </div>
            </div>
        </div>

        <div id="page-reqs" class="hidden">
            <h1 class="text-3xl font-bold mb-6">รายการฝาก-ถอน</h1>
            <div class="glass-card overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-white/5 text-slate-400"><tr><th class="p-4">User</th><th>Type</th><th>Amount</th><th>Action</th></tr></thead>
                    <tbody id="list-reqs"><tr><td colspan="4" class="p-8 text-center text-slate-500">...รอโหลด...</td></tr></tbody>
                </table>
            </div>
        </div>

        <div id="page-rooms" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">จัดการห้อง</h1>
                <button onclick="Admin.createRoom()" class="bg-blue-600 px-4 py-2 rounded-lg">+ สร้างห้อง</button>
            </div>
            <div id="list-rooms" class="grid grid-cols-2 gap-4"></div>
        </div>

    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAHAkBhypqyJuuL22tLrFKN7ZqdEsqGDTk", authDomain: "rsdm-9ca2a.firebaseapp.com", projectId: "rsdm-9ca2a", storageBucket: "rsdm-9ca2a.firebasestorage.app", messagingSenderId: "299212700124", appId: "1:299212700124:web:730160dae6bb1b09cbb719" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); 
        const db = firebase.firestore();

        // --- CHECK CONNECTION ---
        const statusBar = document.getElementById('status-bar');
        db.collection('test_connection').doc('ping').get()
            .then(() => { statusBar.innerText = "DB Connected ✅"; statusBar.className = "st-ok"; })
            .catch((e) => { statusBar.innerText = "DB Error: " + e.code + " (เช็ค Rules!) ❌"; statusBar.className = "st-err"; });

        const UI = {
            tab: (id) => {
                ['dash','reqs','rooms'].forEach(p => {
                    document.getElementById(`page-${p}`).classList.add('hidden');
                    document.getElementById(`tab-${p}`).classList.remove('active');
                });
                document.getElementById(`page-${id}`).classList.remove('hidden');
                document.getElementById(`tab-${id}`).classList.add('active');
            },
            toast: (msg) => Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: msg, showConfirmButton: false, timer: 1500, background: '#1e293b', color: '#fff' })
        };

        const Admin = {
            login: () => {
                auth.signInWithEmailAndPassword(document.getElementById('a-email').value, document.getElementById('a-pass').value)
                .catch(e => Swal.fire('Error', e.message, 'error'));
            },

            // --- MAGIC FIX BUTTON ---
            forceFix: async () => {
                const c = confirm("กดปุ่มนี้เพื่อสร้างข้อมูลตัวอย่าง (User, Request, Room) ยืนยัน?");
                if(!c) return;
                try {
                    // Create Dummy Room
                    await db.collection('rooms').add({ roomName: 'Test Room', betAmount: 0, gameType: 'xo', players: [], createdAt: new Date() });
                    // Create Dummy Request
                    await db.collection('requests').add({ uid: 'test_uid', nickname: 'TestUser', type: 'deposit', amount: 100, status: 'pending', timestamp: new Date() });
                    // Create Dummy Config
                    await db.collection('config').doc('settings').set({ isOpen: true }, {merge:true});
                    UI.toast("สร้างข้อมูลแล้ว! รอสักครู่...");
                } catch(e) { Swal.fire('Error', e.message, 'error'); }
            },

            loadData: () => {
                // 1. Requests (No OrderBy to prevent crash)
                db.collection('requests').onSnapshot(snap => {
                    const list = document.getElementById('list-reqs');
                    const all = snap.docs.map(d => ({id:d.id, ...d.data()}));
                    const pending = all.filter(r => r.status === 'pending');
                    
                    document.getElementById('stat-pending').innerText = pending.length;

                    if(pending.length === 0) { list.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-slate-500">ไม่มีรายการค้าง (ว่าง)</td></tr>'; return; }

                    list.innerHTML = pending.map(r => `
                        <tr class="border-b border-white/10 hover:bg-white/5">
                            <td class="p-4">${r.nickname}<br><span class="text-xs text-slate-500">${r.uid.slice(0,5)}...</span></td>
                            <td class="p-4"><span class="${r.type=='deposit'?'text-green-400':'text-red-400'} font-bold uppercase">${r.type}</span></td>
                            <td class="p-4 text-xl font-bold">${r.amount}</td>
                            <td class="p-4">
                                <button onclick="Admin.decide('${r.id}','approved','${r.uid}',${r.amount},'${r.type}')" class="bg-green-600 px-3 py-1 rounded mr-2">✔</button>
                                <button onclick="Admin.decide('${r.id}','rejected','${r.uid}',${r.amount},'${r.type}')" class="bg-red-600 px-3 py-1 rounded">✖</button>
                            </td>
                        </tr>
                    `).join('');
                });

                // 2. Rooms
                db.collection('rooms').onSnapshot(snap => {
                    document.getElementById('stat-rooms').innerText = snap.size;
                    const list = document.getElementById('list-rooms');
                    if(snap.empty) { list.innerHTML = '<div class="col-span-2 text-center text-slate-500 p-10">ยังไม่มีห้อง</div>'; return; }
                    list.innerHTML = snap.docs.map(d => {
                        const r = d.data();
                        return `<div class="glass-card p-4 flex justify-between items-center">
                            <div><div class="font-bold">${r.roomName}</div><div class="text-xs text-slate-400">Pass: ${r.password}</div></div>
                            <button onclick="db.collection('rooms').doc('${d.id}').delete()" class="text-red-400"><i class="fa-solid fa-trash"></i></button>
                        </div>`;
                    }).join('');
                });

                // 3. Users
                db.collection('users').onSnapshot(snap => document.getElementById('stat-users').innerText = snap.size);
            },

            decide: async (rid, status, uid, amt, type) => {
                const batch = db.batch();
                if(status === 'approved') {
                    const uRef = db.collection('users').doc(uid);
                    // Check user exist first? (Skipped for speed)
                    if(type == 'deposit') batch.update(uRef, { credit: firebase.firestore.FieldValue.increment(amt) });
                    else batch.update(uRef, { credit: firebase.firestore.FieldValue.increment(-amt) });
                }
                batch.update(db.collection('requests').doc(rid), { status: status });
                await batch.commit();
                UI.toast('Saved');
            },

            createRoom: async () => {
                const { value: n } = await Swal.fire({ input: 'text', title: 'ชื่อห้อง', background: '#1e293b', color: '#fff' });
                if(n) db.collection('rooms').add({ roomName: n, password: '123', betAmount: 0, gameType: 'xo', players: [], createdAt: new Date() });
            }
        };

        auth.onAuthStateChanged(u => {
            if(u) {
                document.getElementById('view-login').style.display = 'none';
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                Admin.loadData();
            } else {
                document.getElementById('view-login').style.display = 'flex';
                document.getElementById('sidebar').classList.add('hidden');
                document.getElementById('main-content').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
