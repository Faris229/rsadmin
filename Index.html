<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN CENTER | CYBER ZONE</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;400;600;800&family=Prompt:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Prompt', 'sans-serif'], display: ['Outfit', 'sans-serif'] },
                    colors: {
                        neon: { purple: '#d946ef', blue: '#4f46e5', cyan: '#06b6d4', red: '#f43f5e' }
                    },
                    animation: { 'float': 'float 3s ease-in-out infinite' },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-5px)' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #020617; color: #fff; overflow-x: hidden; }
        
        /* Background */
        .bg-grid {
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px; position: fixed; inset: 0; z-index: -2;
        }
        .bg-glow {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 0% 0%, rgba(79, 70, 229, 0.15), transparent 40%),
                        radial-gradient(circle at 100% 100%, rgba(217, 70, 239, 0.15), transparent 40%);
            z-index: -1;
        }

        /* Glass UI */
        .sidebar { width: 280px; height: 100vh; position: fixed; left: 0; top: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(20px); border-right: 1px solid rgba(255,255,255,0.05); z-index: 50; }
        .main-content { margin-left: 280px; padding: 40px; }
        .glass-card { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 20px; transition: 0.3s; }
        .glass-card:hover { border-color: #4f46e5; box-shadow: 0 0 30px rgba(79, 70, 229, 0.1); }

        /* Inputs */
        .input-adm { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid #334155; padding: 12px; border-radius: 10px; color: white; outline: none; transition: 0.3s; }
        .input-adm:focus { border-color: #d946ef; background: rgba(0,0,0,0.5); }

        /* Menu Items */
        .menu-item { display: flex; items-center; gap: 12px; padding: 16px; border-radius: 12px; color: #94a3b8; transition: 0.3s; cursor: pointer; margin-bottom: 8px; }
        .menu-item:hover, .menu-item.active { background: linear-gradient(90deg, rgba(79,70,229,0.2), transparent); color: #fff; border-left: 4px solid #4f46e5; }
        .menu-item i { width: 24px; text-align: center; font-size: 1.2rem; }

        /* Table */
        th { text-transform: uppercase; font-size: 0.75rem; color: #94a3b8; padding: 16px; font-weight: 700; letter-spacing: 1px; }
        td { padding: 16px; border-top: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; }
        tr:hover { background: rgba(255,255,255,0.02); }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); z-index: 100; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #0f172a; border: 1px solid #334155; width: 100%; max-width: 550px; border-radius: 24px; padding: 30px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); position: relative; animation: zoomIn 0.3s; }
    </style>
</head>
<body class="flex min-h-screen">

    <div class="bg-grid"></div>
    <div class="bg-glow"></div>

    <div id="view-login" class="fixed inset-0 z-[200] bg-[#020617] flex items-center justify-center p-6">
        <div class="w-full max-w-sm text-center">
            <div class="mb-8 relative inline-block">
                <div class="absolute inset-0 bg-purple-600 blur-3xl opacity-30 animate-pulse"></div>
                <h1 class="text-5xl font-black font-display tracking-tighter text-white relative z-10">ADMIN OP</h1>
            </div>
            <div class="space-y-4 glass-card p-8 rounded-3xl">
                <input id="a-email" value="faris@gmail.com" class="input-adm text-center" placeholder="Email">
                <input id="a-pass" type="password" class="input-adm text-center" placeholder="Password">
                <button onclick="Admin.login()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 py-3 rounded-xl font-bold hover:shadow-lg hover:shadow-blue-500/30 transition">ACCESS SYSTEM</button>
            </div>
        </div>
    </div>

    <aside class="sidebar flex flex-col p-6">
        <div class="mb-10 flex items-center gap-3 px-2">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg"><i class="fa-solid fa-shield-halved text-white"></i></div>
            <div>
                <div class="font-bold text-xl font-display tracking-wider">COMMAND</div>
                <div class="text-[10px] text-emerald-400 tracking-widest font-bold">● ONLINE</div>
            </div>
        </div>
        
        <nav class="flex-1">
            <div onclick="UI.tab('dash')" id="tab-dash" class="menu-item active"><i class="fa-solid fa-chart-pie text-blue-400"></i> แดชบอร์ด</div>
            <div onclick="UI.tab('rooms')" id="tab-rooms" class="menu-item"><i class="fa-solid fa-gamepad text-purple-400"></i> จัดการห้อง</div>
            <div onclick="UI.tab('users')" id="tab-users" class="menu-item"><i class="fa-solid fa-users text-pink-400"></i> ผู้เล่น</div>
            <div onclick="UI.tab('trans')" id="tab-trans" class="menu-item"><i class="fa-solid fa-money-bill-transfer text-green-400"></i> เติม / ถอน</div>
            <div onclick="UI.tab('settings')" id="tab-settings" class="menu-item"><i class="fa-solid fa-sliders text-orange-400"></i> ตั้งค่าเว็บ</div>
        </nav>

        <button onclick="auth.signOut()" class="bg-white/5 hover:bg-red-500/20 text-red-400 py-3 rounded-xl font-bold transition flex items-center justify-center gap-2">
            <i class="fa-solid fa-power-off"></i> LOGOUT
        </button>
    </aside>

    <div class="main-content flex-1">
        
        <div id="page-dash" class="animate__animated animate__fadeIn">
            <header class="mb-8">
                <h1 class="text-3xl font-bold font-display">DASHBOARD OVERVIEW</h1>
                <p class="text-slate-400">ภาพรวมสถานะของระบบแบบ Real-time</p>
            </header>

            <div class="grid grid-cols-4 gap-6 mb-10">
                <div class="glass-card p-6 relative overflow-hidden">
                    <div class="text-xs text-slate-400 font-bold uppercase tracking-widest mb-2">Total Users</div>
                    <div id="stat-users" class="text-4xl font-bold text-white">0</div>
                    <i class="fa-solid fa-users absolute bottom-4 right-4 text-4xl opacity-10"></i>
                </div>
                <div class="glass-card p-6 relative overflow-hidden border-l-4 border-l-purple-500">
                    <div class="text-xs text-slate-400 font-bold uppercase tracking-widest mb-2">Active Rooms</div>
                    <div id="stat-rooms" class="text-4xl font-bold text-purple-400">0</div>
                    <i class="fa-solid fa-gamepad absolute bottom-4 right-4 text-4xl opacity-10"></i>
                </div>
                <div class="glass-card p-6 relative overflow-hidden border-l-4 border-l-green-500">
                    <div class="text-xs text-slate-400 font-bold uppercase tracking-widest mb-2">Deposits (Today)</div>
                    <div id="stat-dep" class="text-3xl font-mono font-bold text-green-400">+0</div>
                </div>
                <div class="glass-card p-6 relative overflow-hidden border-l-4 border-l-red-500">
                    <div class="text-xs text-slate-400 font-bold uppercase tracking-widest mb-2">Withdraws (Today)</div>
                    <div id="stat-wit" class="text-3xl font-mono font-bold text-red-400">-0</div>
                </div>
            </div>

            <div class="glass-card p-0 overflow-hidden">
                <div class="p-6 border-b border-white/5 flex justify-between items-center bg-white/5">
                    <h3 class="font-bold text-lg"><i class="fa-solid fa-list-ul mr-2 text-blue-500"></i> Live Transactions</h3>
                    <span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded animate-pulse">LIVE FEED</span>
                </div>
                <table class="w-full text-left">
                    <thead><tr><th>User ID</th><th>Type</th><th>Amount</th><th class="text-right">Time</th></tr></thead>
                    <tbody id="live-trans"></tbody>
                </table>
            </div>
        </div>

        <div id="page-rooms" class="hidden animate__animated animate__fadeIn">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold font-display">ROOM MANAGEMENT</h1>
                <button onclick="UI.modal('create-room', true)" class="bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-xl font-bold shadow-lg shadow-blue-500/30 flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i> สร้างห้องใหม่
                </button>
            </div>
            <div id="admin-room-list" class="grid grid-cols-2 gap-6">
                </div>
        </div>

        <div id="page-users" class="hidden animate__animated animate__fadeIn">
            <h1 class="text-3xl font-bold font-display mb-8">USER MANAGEMENT</h1>
            <div class="glass-card p-0 overflow-hidden">
                <div class="p-4 border-b border-white/5">
                    <input id="search-user" onkeyup="Admin.filterUsers()" class="input-adm w-64" placeholder="ค้นหาชื่อ / Email / ID...">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead><tr><th>Profile</th><th>Bank Info</th><th>Credit</th><th>Action</th></tr></thead>
                        <tbody id="admin-user-list"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="page-trans" class="hidden animate__animated animate__fadeIn">
            <h1 class="text-3xl font-bold font-display mb-8">FINANCIAL SYSTEM</h1>
            <div class="grid grid-cols-2 gap-8">
                <div class="glass-card p-8 border-t-4 border-t-green-500">
                    <h3 class="text-xl font-bold text-green-400 mb-6 flex items-center gap-2"><i class="fa-solid fa-circle-plus"></i> เติมเงิน (Deposit)</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-slate-400 font-bold ml-1">User ID / Email</label>
                            <input id="dep-uid" class="input-adm" placeholder="ระบุผู้รับ">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400 font-bold ml-1">Amount</label>
                            <input id="dep-amt" type="number" class="input-adm" placeholder="จำนวนเงิน">
                        </div>
                        <button onclick="Admin.money('deposit')" class="w-full bg-green-600 hover:bg-green-500 py-3 rounded-xl font-bold mt-2">ยืนยันการเติมเงิน</button>
                    </div>
                </div>
                <div class="glass-card p-8 border-t-4 border-t-red-500">
                    <h3 class="text-xl font-bold text-red-400 mb-6 flex items-center gap-2"><i class="fa-solid fa-circle-minus"></i> ถอนเงิน (Withdraw)</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-slate-400 font-bold ml-1">User ID / Email</label>
                            <input id="wit-uid" class="input-adm" placeholder="ระบุผู้ถอน">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400 font-bold ml-1">Amount</label>
                            <input id="wit-amt" type="number" class="input-adm" placeholder="จำนวนเงิน">
                        </div>
                        <button onclick="Admin.money('withdraw')" class="w-full bg-red-600 hover:bg-red-500 py-3 rounded-xl font-bold mt-2">ยืนยันการถอนเงิน</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-settings" class="hidden animate__animated animate__fadeIn">
            <h1 class="text-3xl font-bold font-display mb-8">SYSTEM SETTINGS</h1>
            <div class="glass-card p-8 max-w-2xl space-y-6">
                <div class="flex items-center justify-between p-4 bg-white/5 rounded-xl border border-white/5">
                    <div>
                        <div class="font-bold text-lg">สถานะเว็บไซต์</div>
                        <div class="text-xs text-slate-400">เปิด/ปิด โหมดปรับปรุงระบบ (ลูกค้าจะเข้าไม่ได้)</div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="set-status" class="sr-only peer">
                        <div class="w-14 h-7 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-green-500"></div>
                    </label>
                </div>
                
                <div>
                    <label class="text-xs text-slate-400 font-bold ml-1">Site Name</label>
                    <input id="set-name" class="input-adm" placeholder="ชื่อเว็บ">
                </div>
                <div>
                    <label class="text-xs text-slate-400 font-bold ml-1">Announcement</label>
                    <textarea id="set-annc" class="input-adm h-24 resize-none" placeholder="ประกาศหน้าเว็บ..."></textarea>
                </div>
                <div>
                    <label class="text-xs text-slate-400 font-bold ml-1">Facebook Link</label>
                    <input id="set-fb" class="input-adm" placeholder="https://m.me/...">
                </div>
                <div>
                    <label class="text-xs text-slate-400 font-bold ml-1">Maintenance Message</label>
                    <input id="set-msg" class="input-adm" placeholder="ข้อความแจ้งเตือนตอนปิดเว็บ">
                </div>
                <button onclick="Admin.saveSettings()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:shadow-lg hover:shadow-purple-500/20 py-3 rounded-xl font-bold transition">บันทึกการตั้งค่า</button>
            </div>
        </div>

    </div>

    <div id="modal-create-room" class="modal-overlay">
        <div class="modal-box">
            <h3 class="font-bold text-xl mb-6 text-white">สร้างห้องใหม่</h3>
            <div class="space-y-4">
                <input id="c-name" class="input-adm" placeholder="ชื่อห้อง">
                <input id="c-pass" class="input-adm" placeholder="รหัสผ่านห้อง">
                <div class="grid grid-cols-2 gap-4">
                    <select id="c-type" class="input-adm bg-[#0f172a]"><option value="xo">XO</option><option value="rps">เป่ายิ้งฉุบ</option></select>
                    <input id="c-win" type="number" class="input-adm" value="3" placeholder="Best of">
                </div>
                <input id="c-bet" type="number" class="input-adm" placeholder="ยอดเดิมพัน (Credit)">
                <div class="flex gap-3 pt-4">
                    <button onclick="UI.modal('create-room', false)" class="flex-1 bg-slate-700 py-3 rounded-xl font-bold hover:bg-slate-600">ยกเลิก</button>
                    <button onclick="Admin.createRoom()" class="flex-1 bg-blue-600 py-3 rounded-xl font-bold hover:bg-blue-500">สร้างทันที</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-spectate" class="modal-overlay">
        <div class="modal-box text-center bg-[#020617] border border-blue-500/30 shadow-2xl shadow-blue-500/20">
            <div class="w-20 h-20 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
                <i class="fa-solid fa-eye text-blue-400 text-3xl"></i>
            </div>
            <h3 class="font-bold text-2xl mb-1 text-white tracking-widest" id="spec-name">ROOM</h3>
            <p class="text-xs text-slate-400 mb-6 font-mono">STATUS: <span id="spec-status" class="text-yellow-400">WAITING</span> | BET: <span id="spec-bet">0</span></p>
            
            <div class="grid grid-cols-3 gap-4 bg-white/5 p-6 rounded-2xl border border-white/5 mb-6">
                <div>
                    <div class="text-[10px] font-bold text-slate-500 uppercase">P1 Score</div>
                    <div id="spec-p1" class="text-4xl font-black text-cyan-400">0</div>
                </div>
                <div class="flex items-center justify-center font-bold text-slate-600 text-2xl">VS</div>
                <div>
                    <div class="text-[10px] font-bold text-slate-500 uppercase">P2 Score</div>
                    <div id="spec-p2" class="text-4xl font-black text-pink-500">0</div>
                </div>
            </div>
            <button onclick="UI.modal('spectate', false)" class="w-full bg-slate-800 py-3 rounded-xl font-bold hover:bg-slate-700">ปิดหน้าต่างดู</button>
        </div>
    </div>

    <div id="modal-edit-user" class="modal-overlay">
        <div class="modal-box">
            <h3 class="font-bold text-xl mb-6">แก้ไขข้อมูลผู้ใช้</h3>
            <input type="hidden" id="e-uid">
            <div class="space-y-4">
                <div><label class="text-xs text-slate-400 font-bold ml-1">Nickname</label><input id="e-nick" class="input-adm"></div>
                <div><label class="text-xs text-slate-400 font-bold ml-1">Credit (แก้โดยตรง)</label><input id="e-credit" type="number" class="input-adm font-mono text-yellow-400 font-bold"></div>
                <div class="flex gap-3 pt-4">
                    <button onclick="UI.modal('edit-user', false)" class="flex-1 bg-slate-700 py-3 rounded-xl font-bold">ยกเลิก</button>
                    <button onclick="Admin.saveUser()" class="flex-1 bg-green-600 py-3 rounded-xl font-bold hover:bg-green-500">บันทึก & สร้าง Log</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAHAkBhypqyJuuL22tLrFKN7ZqdEsqGDTk",
            authDomain: "rsdm-9ca2a.firebaseapp.com",
            projectId: "rsdm-9ca2a",
            storageBucket: "rsdm-9ca2a.firebasestorage.app",
            messagingSenderId: "299212700124",
            appId: "1:299212700124:web:730160dae6bb1b09cbb719"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let allUsers = [], specUnsub = null;

        // UI & AUTH
        const UI = {
            tab: (id) => {
                ['dash','rooms','users','trans','settings'].forEach(p => {
                    document.getElementById(`page-${p}`).classList.add('hidden');
                    document.getElementById(`tab-${p}`).classList.remove('active');
                });
                document.getElementById(`page-${id}`).classList.remove('hidden');
                document.getElementById(`tab-${id}`).classList.add('active');
            },
            modal: (id, show) => document.getElementById(`modal-${id}`).style.display = show ? 'flex' : 'none',
            toast: (msg) => Swal.fire({ title: msg, icon: 'success', toast: true, position: 'top-end', showConfirmButton: false, timer: 2000, background: '#1e293b', color: '#fff' })
        };

        const Admin = {
            login: () => {
                const e = document.getElementById('a-email').value, p = document.getElementById('a-pass').value;
                auth.signInWithEmailAndPassword(e,p).catch(err => alert(err.message));
            },
            
            // ROOMS
            createRoom: () => {
                const n = document.getElementById('c-name').value, p = document.getElementById('c-pass').value, t = document.getElementById('c-type').value;
                const b = parseInt(document.getElementById('c-bet').value), w = parseInt(document.getElementById('c-win').value);
                if(!n||!p||!b) return alert('กรอกให้ครบ');
                
                db.collection('rooms').add({
                    roomName: n, password: p, gameType: t, betAmount: b, maxWins: w,
                    players: [], status: 'waiting', scores: {}, board: Array(9).fill(null), moves: {}, roundState: 'idle',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                UI.modal('create-room', false);
                UI.toast('สร้างห้องสำเร็จ');
            },
            deleteRoom: (id) => {
                Swal.fire({ title: 'ลบห้องนี้?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', background: '#1e293b', color:'#fff' }).then((r) => {
                    if(r.isConfirmed) db.collection('rooms').doc(id).delete();
                });
            },
            spectate: (id) => {
                if(specUnsub) specUnsub();
                UI.modal('spectate', true);
                specUnsub = db.collection('rooms').doc(id).onSnapshot(doc => {
                    if(!doc.exists) { UI.modal('spectate', false); return; }
                    const r = doc.data();
                    document.getElementById('spec-name').innerText = r.roomName;
                    document.getElementById('spec-status').innerText = r.players.length < 2 ? 'WAITING' : 'LIVE';
                    document.getElementById('spec-bet').innerText = r.betAmount;
                    const p1=r.players[0], p2=r.players[1];
                    document.getElementById('spec-p1').innerText = r.scores[p1] || 0;
                    document.getElementById('spec-p2').innerText = r.scores[p2] || 0;
                });
            },

            // USERS
            filterUsers: () => {
                const txt = document.getElementById('search-user').value.toLowerCase();
                const filtered = allUsers.filter(u => u.nickname.toLowerCase().includes(txt) || u.email.toLowerCase().includes(txt));
                Admin.renderUsers(filtered);
            },
            renderUsers: (users) => {
                const list = document.getElementById('admin-user-list');
                list.innerHTML = users.map(u => `
                    <tr class="hover:bg-white/5 transition border-t border-white/5">
                        <td class="p-4 pl-6">
                            <div class="font-bold text-white">${u.nickname}</div>
                            <div class="text-xs text-slate-500 font-mono select-all">${u.id}</div>
                            <div class="text-xs text-slate-400">${u.email}</div>
                        </td>
                        <td class="p-4 text-xs text-slate-300">
                            <div class="font-bold text-purple-400">${u.bankName || '-'}</div>
                            <div>${u.bankAcc || '-'}</div>
                        </td>
                        <td class="p-4 font-mono font-bold text-yellow-400 text-lg">${u.credit.toLocaleString()}</td>
                        <td class="p-4">
                            <button onclick="Admin.openEdit('${u.id}', '${u.nickname}', ${u.credit})" class="bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded-lg text-xs font-bold transition shadow-md">EDIT</button>
                        </td>
                    </tr>
                `).join('');
            },
            openEdit: (id, nick, cred) => {
                document.getElementById('e-uid').value = id;
                document.getElementById('e-nick').value = nick;
                document.getElementById('e-credit').value = cred;
                UI.modal('edit-user', true);
            },
            saveUser: () => {
                const id = document.getElementById('e-uid').value;
                const n = document.getElementById('e-nick').value;
                const c = parseFloat(document.getElementById('e-credit').value);
                
                db.collection('users').doc(id).get().then(doc => {
                    const old = doc.data().credit;
                    db.collection('users').doc(id).update({ nickname: n, credit: c });
                    if(old !== c) {
                        const diff = c - old;
                        db.collection('transactions').add({ uid: id, type: 'admin_adj', amount: diff, note: `Admin Edited Balance (${old} -> ${c})`, timestamp: new Date() });
                    }
                    UI.toast('บันทึกข้อมูลแล้ว');
                    UI.modal('edit-user', false);
                });
            },

            // MONEY
            money: async (type) => {
                const input = document.getElementById(type=='deposit'?'dep-uid':'wit-uid').value;
                const amt = parseFloat(document.getElementById(type=='deposit'?'dep-amt':'wit-amt').value);
                if(!input || !amt) return alert('กรอกข้อมูลให้ครบ');

                let target = null;
                const byEmail = await db.collection('users').where('email', '==', input).get();
                if(!byEmail.empty) target = byEmail.docs[0];
                else {
                    const byUid = await db.collection('users').doc(input).get();
                    if(byUid.exists) target = byUid;
                }

                if(!target) return alert('ไม่พบผู้ใช้');
                
                const change = type === 'deposit' ? amt : -amt;
                await db.collection('users').doc(target.id).update({ credit: firebase.firestore.FieldValue.increment(change) });
                await db.collection('transactions').add({ uid: target.id, type: type, amount: change, note: `Admin Action`, timestamp: new Date() });
                UI.toast('ทำรายการสำเร็จ');
                document.getElementById(type=='deposit'?'dep-uid':'wit-uid').value = '';
                document.getElementById(type=='deposit'?'dep-amt':'wit-amt').value = '';
            },

            // SETTINGS
            loadSettings: () => {
                db.collection('config').doc('settings').onSnapshot(doc => {
                    if(doc.exists) {
                        const d = doc.data();
                        document.getElementById('set-status').checked = d.isOpen !== false;
                        document.getElementById('set-name').value = d.siteName || '';
                        document.getElementById('set-annc').value = d.announcement || '';
                        document.getElementById('set-fb').value = d.fbLink || '';
                        document.getElementById('set-msg').value = d.maintenanceMsg || '';
                    }
                });
            },
            saveSettings: () => {
                db.collection('config').doc('settings').set({
                    isOpen: document.getElementById('set-status').checked,
                    siteName: document.getElementById('set-name').value,
                    announcement: document.getElementById('set-annc').value,
                    fbLink: document.getElementById('set-fb').value,
                    maintenanceMsg: document.getElementById('set-msg').value
                }, { merge: true });
                UI.toast('บันทึกการตั้งค่าแล้ว');
            }
        };

        // INIT
        auth.onAuthStateChanged(user => {
            if(user && user.email === 'faris@gmail.com') {
                document.getElementById('view-login').style.display = 'none';
                Admin.loadSettings();

                // Listeners
                db.collection('rooms').onSnapshot(snap => {
                    document.getElementById('stat-rooms').innerText = snap.size;
                    const list = document.getElementById('admin-room-list');
                    list.innerHTML = snap.docs.map(doc => {
                        const r = doc.data();
                        const borderColor = r.gameType === 'xo' ? 'border-blue-500' : 'border-pink-500';
                        const type = r.gameType.toUpperCase();
                        return `<div class="glass-card p-5 border-l-4 ${borderColor} flex justify-between items-center group hover:bg-white/5">
                            <div>
                                <div class="font-bold text-lg text-white group-hover:text-purple-400 transition">${r.roomName}</div>
                                <div class="text-xs text-slate-400 font-mono mt-1"><span class="bg-white/10 px-1 rounded">${type}</span> Pass: ${r.password} | Bet: ${r.betAmount}</div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="Admin.spectate('${doc.id}')" class="bg-blue-600/20 text-blue-400 px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-600 hover:text-white transition">Watch</button>
                                <button onclick="Admin.deleteRoom('${doc.id}')" class="bg-red-600/20 text-red-400 px-3 py-1 rounded-lg text-xs font-bold hover:bg-red-600 hover:text-white transition">Del</button>
                            </div>
                        </div>`;
                    }).join('');
                });

                db.collection('users').onSnapshot(snap => {
                    document.getElementById('stat-users').innerText = snap.size;
                    allUsers = [];
                    snap.forEach(doc => allUsers.push({id: doc.id, ...doc.data()}));
                    Admin.renderUsers(allUsers);
                });

                // Live Trans (Client Sort)
                db.collection('transactions').orderBy('timestamp', 'desc').limit(20).onSnapshot(snap => {
                    const list = document.getElementById('live-trans');
                    let dep = 0, wit = 0;
                    
                    list.innerHTML = snap.docs.map(doc => {
                        const d = doc.data();
                        if(d.type === 'deposit') dep += d.amount;
                        if(d.type === 'withdraw') wit += Math.abs(d.amount);
                        
                        const color = d.amount > 0 ? 'text-green-400' : 'text-red-400';
                        return `<tr class="border-b border-white/5 hover:bg-white/5 transition">
                            <td class="p-4 font-mono text-xs text-slate-400">${d.uid.slice(0,6)}...</td>
                            <td class="p-4"><span class="bg-white/10 px-2 py-1 rounded text-xs font-bold text-slate-300 uppercase">${d.type}</span></td>
                            <td class="p-4 font-bold ${color}">${d.amount}</td>
                            <td class="p-4 text-right text-xs text-slate-500 font-mono">${d.timestamp?new Date(d.timestamp.toDate()).toLocaleTimeString():'-'}</td>
                        </tr>`;
                    }).join('');
                    
                    // Simple Daily Estimate (Reset on refresh)
                    document.getElementById('stat-dep').innerText = '+' + dep.toLocaleString();
                    document.getElementById('stat-wit').innerText = '-' + wit.toLocaleString();
                });

            } else {
                document.getElementById('view-login').style.display = 'flex';
            }
        });
    </script>
</body>
</html>
