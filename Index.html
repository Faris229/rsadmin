<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Admin - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f3f4f6; }
        .sidebar-link { display: flex; align-items: center; padding: 12px 20px; color: #64748b; font-weight: 500; border-radius: 12px; margin-bottom: 4px; transition: 0.2s; cursor: pointer; }
        .sidebar-link:hover { background: #e2e8f0; color: #1e293b; }
        .sidebar-link.active { background: #2563eb; color: white; shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .badge-count { background: #ef4444; color: white; font-size: 10px; padding: 2px 8px; border-radius: 20px; margin-left: auto; }
        .order-card { background: white; border-radius: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; transition: 0.2s; }
        .order-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col z-20">
        <div class="h-20 flex items-center px-6 border-b border-gray-100">
            <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i class="fa-solid fa-cube text-blue-600"></i> Q-Store Admin</h1>
        </div>
        <nav class="flex-1 p-4 space-y-1">
            <div onclick="App.switchTab('pending')" id="tab-pending" class="sidebar-link active"><i class="fa-solid fa-inbox w-6"></i> ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà <span id="count-pending" class="badge-count hidden">0</span></div>
            <div onclick="App.switchTab('working')" id="tab-working" class="sidebar-link"><i class="fa-solid fa-hammer w-6"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ <span id="count-working" class="badge-count bg-blue-500 hidden">0</span></div>
            <div onclick="App.switchTab('completed')" id="tab-completed" class="sidebar-link"><i class="fa-solid fa-circle-check w-6"></i> ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>
        </nav>
        <div class="p-4 border-t border-gray-100">
            <button onclick="Auth.logout()" class="w-full text-left text-sm text-red-500 font-bold hover:bg-red-50 p-3 rounded-lg transition"><i class="fa-solid fa-sign-out-alt mr-2"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative">
        <header class="h-20 bg-white/80 backdrop-blur border-b border-gray-200 flex items-center justify-between px-8 sticky top-0 z-10">
            <h2 id="page-title" class="text-2xl font-bold text-slate-800">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà</h2>
            <div class="text-sm text-gray-500 font-medium">Logged in as: <span class="text-blue-600">faris@gmail.com</span></div>
        </header>
        <div id="content-area" class="flex-1 overflow-y-auto p-8">
            <div id="loading" class="text-center text-gray-400 mt-20"><i class="fa-solid fa-circle-notch fa-spin text-3xl"></i><br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
            <div id="order-list" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
        </div>
    </main>

    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAHAkBhypqyJuuL22tLrFKN7ZqdEsqGDTk",
            authDomain: "rsdm-9ca2a.firebaseapp.com",
            projectId: "rsdm-9ca2a",
            storageBucket: "rsdm-9ca2a.firebasestorage.app",
            messagingSenderId: "299212700124",
            appId: "1:299212700124:web:730160dae6bb1b09cbb719",
            measurementId: "G-CMX9GKW7FF"
        };
        const SUPER_ADMIN_EMAIL = "faris@gmail.com"; 

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- 2. THE ULTIMATE CODE TEMPLATES (‡∏¢‡∏±‡∏î‡πÑ‡∏™‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏•‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß) ---
        
        // 2.1 CLIENT CODE TEMPLATE
        const RAW_CLIENT_CODE = `<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß - {{SHOP_NAME}}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>body{font-family:'Sarabun',sans-serif;background-color:#f8fafc}.glass-card{background:rgba(255,255,255,0.98);border-radius:1.5rem;border:1px solid #e2e8f0;box-shadow:0 10px 30px -10px rgba(0,0,0,0.08)}.btn-gradient{background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%);color:white;transition:0.2s}.st-call{animation:pulse 1.5s infinite}@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(34,197,94,0.4)}70%{box-shadow:0 0 0 10px rgba(34,197,94,0)}100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}}</style>
</head>
<body class="min-h-screen flex flex-col pt-16 px-4">
    <header class="mb-6 flex justify-between items-end max-w-md mx-auto w-full">
        <div><h1 class="font-bold text-2xl text-slate-800 leading-none" id="shop-name">{{SHOP_NAME}}</h1><div id="shop-badge" class="mt-2 inline-flex items-center gap-2 px-3 py-1 bg-white rounded-full text-xs font-bold shadow-sm border">Loading...</div></div>
        <div class="text-right"><div class="text-xs text-slate-400 font-bold uppercase mb-1">‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div><div class="text-4xl font-black text-slate-800 leading-none" id="current-q">---</div></div>
    </header>
    <main class="flex-1 max-w-md mx-auto w-full flex flex-col justify-start relative">
        <div id="form-section" class="glass-card p-6 animate__animated animate__fadeInUp">
            <h3 class="font-bold text-xl text-slate-700 mb-4">‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡∏°‡πà</h3>
            <form onsubmit="App.book(event)" class="space-y-4">
                <input id="inp-name" class="w-full p-3.5 bg-slate-50 border rounded-xl" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" required>
                <input id="inp-phone" type="tel" class="w-full p-3.5 bg-slate-50 border rounded-xl" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">
                <div class="grid grid-cols-2 gap-4">
                    <select id="inp-pax" class="w-full p-3.5 bg-slate-50 border rounded-xl"><option value="1">1 ‡∏ó‡πà‡∏≤‡∏ô</option><option value="2">2 ‡∏ó‡πà‡∏≤‡∏ô</option><option value="3+">3+ ‡∏ó‡πà‡∏≤‡∏ô</option></select>
                    <input id="inp-time" type="time" class="w-full p-3.5 bg-slate-50 border rounded-xl text-center" required>
                </div>
                <button class="btn-gradient w-full py-4 rounded-xl font-bold text-lg shadow-lg mt-4">‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏Ñ‡∏¥‡∏ß</button>
            </form>
        </div>
        <div id="ticket-section" class="hidden glass-card p-8 text-center animate__animated animate__zoomIn">
            <div class="text-xs text-slate-400 uppercase tracking-widest mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
            <div id="my-q-num" class="text-7xl font-black text-slate-800 mb-2">---</div>
            <div id="queue-ahead-box" class="bg-orange-50 border border-orange-100 px-4 py-2 rounded-lg mb-6"><span class="text-xs font-bold text-orange-600">‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠ <span id="ahead-count">0</span> ‡∏Ñ‡∏¥‡∏ß</span></div>
            <div class="text-left text-sm mb-4"><span class="text-slate-400">‡∏ä‡∏∑‡πà‡∏≠:</span> <span id="my-name" class="font-bold">...</span></div>
            <button onclick="App.testSound()" class="w-full py-3 rounded-xl bg-slate-100 text-slate-600 font-bold mb-3">üîä ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
            <button onclick="App.cancel()" class="text-sm text-red-400 underline">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏¥‡∏ß</button>
        </div>
    </main>
    <script>
        const firebaseConfig = { apiKey: "{{API_KEY}}", authDomain: "{{PROJECT_ID}}.firebaseapp.com", projectId: "{{PROJECT_ID}}", storageBucket: "{{PROJECT_ID}}.firebasestorage.app", messagingSenderId: "{{SENDER_ID}}", appId: "{{APP_ID}}" };
        firebase.initializeApp(firebaseConfig); const db=firebase.firestore();
        class CustomerApp {
            constructor(){this.myId=localStorage.getItem('q_id'); this.init();}
            init(){
                if(this.myId) this.listenTicket(); 
                db.collection('q_system').doc('config').onSnapshot(d=>{
                    if(d.exists){ document.getElementById('current-q').innerText=d.data().current||'---'; document.getElementById('shop-name').innerText=d.data().shopName||'{{SHOP_NAME}}'; }
                });
            }
            listenTicket(){
                db.collection('q_system').doc('config').collection('queues').doc(this.myId).onSnapshot(d=>{
                    if(!d.exists) return localStorage.removeItem('q_id'),location.reload();
                    const dat=d.data();
                    if(dat.status==='served') Swal.fire('‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô','‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£','success').then(()=>this.logout());
                    else {
                        document.getElementById('form-section').classList.add('hidden');
                        document.getElementById('ticket-section').classList.remove('hidden');
                        document.getElementById('my-q-num').innerText=dat.number;
                        document.getElementById('my-name').innerText=dat.name;
                        if(dat.status==='called') { 
                            if(navigator.vibrate) navigator.vibrate(500); 
                            Swal.fire({title:'‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß',timer:2000,showConfirmButton:false});
                            this.speak(dat.voiceMessage);
                        }
                    }
                });
            }
            async book(e){
                e.preventDefault(); const btn=e.target.querySelector('button'); btn.disabled=true;
                try{
                    await db.runTransaction(async t=>{
                        const ref=db.collection('q_system').doc('config'); const doc=await t.get(ref); const d=doc.data();
                        const next=(d.last||0)+1; const num=(d.queuePrefix||'A-')+String(next).padStart(3,'0');
                        const qRef=ref.collection('queues').doc();
                        t.set(qRef,{number:num, raw:next, name:document.getElementById('inp-name').value, status:'waiting', timestamp:firebase.firestore.FieldValue.serverTimestamp()});
                        t.update(ref,{last:next}); localStorage.setItem('q_id',qRef.id); this.myId=qRef.id;
                    });
                    this.listenTicket();
                }catch(err){ btn.disabled=false; alert(err.message); }
            }
            cancel(){ if(confirm('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å?')) db.collection('q_system').doc('config').collection('queues').doc(this.myId).update({status:'cancelled'}); }
            logout(){ localStorage.removeItem('q_id'); location.reload(); }
            testSound(){ this.speak('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á'); }
            speak(t){ if('speechSynthesis' in window){ window.speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(t); u.lang='th-TH'; window.speechSynthesis.speak(u); }}
        }
        const App=new CustomerApp();
    <\/script>
</body>
</html>`;

        // 2.2 ADMIN CODE TEMPLATE
        const RAW_ADMIN_CODE = `<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - {{SHOP_NAME}}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>body{font-family:'Sarabun',sans-serif;background:#f1f5f9}.btn-action{padding:8px 16px;border-radius:8px;font-weight:700;display:inline-flex;align-items:center;gap:6px;cursor:pointer}.btn-call{background:#eff6ff;color:#2563eb}.btn-done{background:#ecfdf5;color:#16a34a}</style>
</head>
<body class="flex h-screen">
    <aside class="w-64 bg-white border-r p-4">
        <h1 class="text-xl font-bold mb-6 text-blue-600">{{SHOP_NAME}}</h1>
        <div class="space-y-2">
            <div class="p-3 bg-blue-50 text-blue-700 rounded-lg font-bold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß</div>
            <button onclick="window.Admin.resetSystem()" class="w-full text-left p-3 text-red-500 font-bold hover:bg-red-50 rounded-lg">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </aside>
    <main class="flex-1 p-8 overflow-y-auto">
        <header class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-bold">‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å</h2>
            <div class="text-right"><div class="text-xs text-gray-400 font-bold">Calling</div><div class="text-4xl font-black text-blue-600" id="header-current">---</div></div>
        </header>
        <div id="tb-live" class="space-y-3"></div>
    </main>
    <script>
        const firebaseConfig = { apiKey: "{{API_KEY}}", authDomain: "{{PROJECT_ID}}.firebaseapp.com", projectId: "{{PROJECT_ID}}", storageBucket: "{{PROJECT_ID}}.firebasestorage.app", messagingSenderId: "{{SENDER_ID}}", appId: "{{APP_ID}}" };
        firebase.initializeApp(firebaseConfig); const db=firebase.firestore();
        class AdminApp {
            constructor(){ 
                this.qRef=db.collection('q_system').doc('config').collection('queues');
                this.cRef=db.collection('q_system').doc('config');
                this.init(); 
            }
            init(){
                this.cRef.onSnapshot(d=>{ if(d.exists) document.getElementById('header-current').innerText=d.data().current||'---'; });
                this.qRef.orderBy('timestamp','asc').onSnapshot(s=>{
                    const active=s.docs.map(d=>({id:d.id,...d.data()})).filter(x=>['waiting','called'].includes(x.status));
                    document.getElementById('tb-live').innerHTML = active.map(d=>\`
                        <div class="bg-white p-4 rounded-xl shadow-sm border flex justify-between items-center \${d.status==='called'?'border-blue-500 border-l-4':''}">
                            <div><span class="text-2xl font-black mr-4">\${d.number}</span> <span class="font-bold">\${d.name}</span></div>
                            <div class="flex gap-2">
                                <button onclick="window.Admin.call('\${d.id}','\${d.number}','\${d.name}')" class="btn-action btn-call">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å</button>
                                <button onclick="window.Admin.serve('\${d.id}')" class="btn-action btn-done">‡∏à‡∏ö</button>
                            </div>
                        </div>\`).join('') || '<div class="text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß</div>';
                });
            }
            call(id,n,nm){ this.qRef.doc(id).update({status:'called',lastCallTime:Date.now(),voiceMessage:'‡πÄ‡∏ä‡∏¥‡∏ç‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç '+n}); this.cRef.update({current:n}); }
            serve(id){ this.qRef.doc(id).update({status:'served'}); }
            resetSystem(){ if(confirm('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï?')) { this.cRef.update({current:'---',last:0}); this.qRef.get().then(s=>{const b=db.batch();s.docs.forEach(d=>b.delete(d.ref));b.commit()}); } }
        }
        window.onload=()=>window.Admin=new AdminApp();
    <\/script>
</body>
</html>`;

        // --- 3. APP LOGIC ---
        let allOrders = [];
        let currentTab = 'pending';

        const Auth = {
            login: () => {
                const e = document.getElementById('adm-email').value;
                const p = document.getElementById('adm-pass').value;
                auth.signInWithEmailAndPassword(e, p).then(() => {
                    if (auth.currentUser.email !== SUPER_ADMIN_EMAIL) {
                        Swal.fire('Access Denied', '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Super Admin', 'error').then(() => auth.signOut());
                    } else {
                        document.getElementById('login-modal').classList.add('hidden');
                    }
                }).catch(err => Swal.fire('Error', err.message, 'error'));
            },
            logout: () => auth.signOut().then(() => location.reload())
        };

        const App = {
            init: () => {
                auth.onAuthStateChanged(user => {
                    if (user && user.email === SUPER_ADMIN_EMAIL) {
                        document.getElementById('login-modal').classList.add('hidden');
                        App.fetchOrders();
                    } else {
                        document.getElementById('login-modal').classList.remove('hidden');
                    }
                });
            },

            fetchOrders: () => {
                db.collection('web_orders').orderBy('timestamp', 'desc').onSnapshot(snap => {
                    allOrders = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    App.updateBadges();
                    App.renderList();
                    document.getElementById('loading').classList.add('hidden');
                });
            },

            updateBadges: () => {
                const pending = allOrders.filter(o => o.status === 'pending').length;
                const working = allOrders.filter(o => ['working', 'testing'].includes(o.status)).length;
                const b1 = document.getElementById('count-pending');
                const b2 = document.getElementById('count-working');
                if(pending>0){b1.innerText=pending;b1.classList.remove('hidden');}else b1.classList.add('hidden');
                if(working>0){b2.innerText=working;b2.classList.remove('hidden');}else b2.classList.add('hidden');
            },

            switchTab: (tab) => {
                currentTab = tab;
                document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
                document.getElementById(`tab-${tab}`).classList.add('active');
                document.getElementById('page-title').innerText = tab === 'pending' ? '‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà' : (tab === 'working' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' : '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
                App.renderList();
            },

            renderList: () => {
                const container = document.getElementById('order-list');
                let filtered = [];
                if (currentTab === 'pending') filtered = allOrders.filter(o => o.status === 'pending');
                else if (currentTab === 'working') filtered = allOrders.filter(o => ['working', 'testing'].includes(o.status));
                else filtered = allOrders.filter(o => o.status === 'completed');

                if (filtered.length === 0) { container.innerHTML = `<div class="col-span-2 text-center py-20 text-gray-400 bg-white rounded-2xl border border-dashed">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`; return; }

                container.innerHTML = filtered.map(o => {
                    const dataJson = encodeURIComponent(JSON.stringify(o));
                    let actions = '';
                    
                    if (currentTab === 'pending') {
                        actions = `<button onclick="App.updateStatus('${o.id}', 'working')" class="w-full py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-md">‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</button>`;
                    } else if (currentTab === 'working') {
                        actions = `
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="App.generateCode('${dataJson}')" class="py-2 bg-purple-100 text-purple-700 rounded-lg font-bold border border-purple-200">‡πÄ‡∏à‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î</button>
                                <button onclick="App.updateStatus('${o.id}', 'completed')" class="py-2 bg-green-600 text-white rounded-lg font-bold shadow-md">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
                            </div>`;
                    } else {
                        actions = `<div class="text-center text-green-600 font-bold bg-green-50 p-2 rounded-lg">‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß</div>`;
                    }

                    return `
                        <div class="order-card p-6 flex flex-col h-full animate__animated animate__fadeIn">
                            <div class="flex justify-between items-start mb-4">
                                <div><h3 class="text-lg font-bold text-gray-800">${o.shopName}</h3><div class="text-sm text-gray-500">${o.customerName}</div></div>
                                <span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded">${new Date(o.timestamp?.toDate()).toLocaleDateString()}</span>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 text-sm space-y-2 mb-6 flex-1">
                                <div class="flex justify-between"><span class="text-gray-400">Email:</span> <span class="text-gray-700 select-all">${o.adminEmail}</span></div>
                                <div class="flex justify-between"><span class="text-gray-400">Pass:</span> <span class="text-gray-700 select-all">${o.adminPass}</span></div>
                            </div>
                            <div class="mt-auto">${actions}</div>
                        </div>`;
                }).join('');
            },

            updateStatus: (id, status) => {
                db.collection('web_orders').doc(id).update({ status: status }).then(() => {
                    const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 1500});
                    Toast.fire({icon: 'success', title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß'});
                });
            },

            generateCode: (jsonStr) => {
                const o = JSON.parse(decodeURIComponent(jsonStr));
                
                // *** FIND & REPLACE LOGIC (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ***
                let clientCode = RAW_CLIENT_CODE
                    .replace(/{{SHOP_NAME}}/g, o.shopName)
                    .replace(/{{API_KEY}}/g, firebaseConfig.apiKey)
                    .replace(/{{PROJECT_ID}}/g, firebaseConfig.projectId)
                    .replace(/{{SENDER_ID}}/g, firebaseConfig.messagingSenderId)
                    .replace(/{{APP_ID}}/g, firebaseConfig.appId);

                let adminCode = RAW_ADMIN_CODE
                    .replace(/{{SHOP_NAME}}/g, o.shopName)
                    .replace(/{{ADM_EMAIL}}/g, o.adminEmail)
                    .replace(/{{ADM_PASS}}/g, o.adminPass)
                    .replace(/{{API_KEY}}/g, firebaseConfig.apiKey)
                    .replace(/{{PROJECT_ID}}/g, firebaseConfig.projectId)
                    .replace(/{{SENDER_ID}}/g, firebaseConfig.messagingSenderId)
                    .replace(/{{APP_ID}}/g, firebaseConfig.appId);

                Swal.fire({
                    title: `Gen Code: ${o.shopName}`,
                    width: '800px',
                    html: `
                        <div class="text-left space-y-4">
                            <div>
                                <label class="text-xs font-bold text-blue-600 block mb-1">1. ‡πÇ‡∏Ñ‡πâ‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (client.html)</label>
                                <div class="relative">
                                    <textarea id="code-client" class="w-full h-32 text-[10px] font-mono border bg-slate-50 rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none" readonly>${clientCode}</textarea>
                                    <button onclick="navigator.clipboard.writeText(document.getElementById('code-client').value)" class="absolute top-2 right-2 bg-white border px-3 py-1 rounded text-xs font-bold hover:bg-gray-50">Copy</button>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-purple-600 block mb-1">2. ‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (admin.html)</label>
                                <div class="relative">
                                    <textarea id="code-admin" class="w-full h-32 text-[10px] font-mono border bg-slate-50 rounded p-2 focus:ring-2 focus:ring-purple-500 outline-none" readonly>${adminCode}</textarea>
                                    <button onclick="navigator.clipboard.writeText(document.getElementById('code-admin').value)" class="absolute top-2 right-2 bg-white border px-3 py-1 rounded text-xs font-bold hover:bg-gray-50">Copy</button>
                                </div>
                            </div>
                        </div>
                    `,
                    showConfirmButton: false, showCloseButton: true
                });
            }
        };

        App.init();
    </script>
</body>
</html>
