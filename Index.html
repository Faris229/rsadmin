<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN | DIAGNOSTIC MODE</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;400;600;800&family=Prompt:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Prompt', 'sans-serif'], display: ['Outfit', 'sans-serif'] },
                    colors: { neon: { purple: '#d946ef', blue: '#4f46e5', cyan: '#06b6d4', red: '#f43f5e' } }
                }
            }
        }
    </script>

    <style>
        body { background-color: #020617; color: #fff; overflow-x: hidden; }
        .glass-card { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; }
        .input-adm { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid #334155; padding: 12px; border-radius: 10px; color: white; outline: none; }
        /* Debug Status Bar */
        #db-status { position: fixed; top: 10px; right: 10px; z-index: 9999; padding: 10px 20px; border-radius: 8px; font-weight: bold; font-family: monospace; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
    </style>
</head>
<body class="flex min-h-screen">

    <div id="db-status" class="bg-gray-800 text-gray-400 border border-gray-600">
        <i class="fa-solid fa-circle-notch fa-spin mr-2"></i> กำลังตรวจสอบการเชื่อมต่อ...
    </div>

    <div id="view-login" class="fixed inset-0 z-[200] bg-[#020617] flex items-center justify-center p-6">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-5xl font-black font-display tracking-tighter text-white mb-8">ADMIN</h1>
            <div class="space-y-4 glass-card p-8">
                <input id="a-email" value="faris@gmail.com" class="input-adm text-center" placeholder="Email">
                <input id="a-pass" type="password" class="input-adm text-center" placeholder="Password">
                <button onclick="Admin.login()" class="w-full bg-blue-600 py-3 rounded-xl font-bold hover:bg-blue-500 transition">LOGIN</button>
            </div>
        </div>
    </div>

    <div id="view-app" class="hidden flex-1 p-8 max-w-7xl mx-auto w-full">
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-4xl font-bold font-display">ADMIN DASHBOARD</h1>
                <p class="text-slate-400">สถานะระบบ: <span class="text-green-400">ONLINE</span></p>
            </div>
            <div class="flex gap-3">
                <button onclick="Admin.fixData()" class="bg-yellow-600 hover:bg-yellow-500 px-6 py-3 rounded-xl font-bold transition shadow-lg"><i class="fa-solid fa-wrench mr-2"></i> สร้างข้อมูลตัวอย่าง (กดเมื่อเว็บโล่ง)</button>
                <button onclick="auth.signOut()" class="bg-red-600 hover:bg-red-500 px-6 py-3 rounded-xl font-bold transition shadow-lg">Logout</button>
            </div>
        </header>

        <div class="grid grid-cols-3 gap-6 mb-8">
            <div class="glass-card p-6 border-l-4 border-blue-500">
                <div class="text-xs text-slate-400 uppercase font-bold">Active Rooms</div>
                <div id="stat-rooms" class="text-4xl font-bold">Loading...</div>
            </div>
            <div class="glass-card p-6 border-l-4 border-green-500">
                <div class="text-xs text-slate-400 uppercase font-bold">Total Users</div>
                <div id="stat-users" class="text-4xl font-bold">Loading...</div>
            </div>
            <div class="glass-card p-6 border-l-4 border-yellow-500">
                <div class="text-xs text-slate-400 uppercase font-bold">Pending Requests</div>
                <div id="stat-reqs" class="text-4xl font-bold">Loading...</div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="glass-card p-6">
                <h3 class="font-bold text-xl mb-4 border-b border-white/10 pb-2">รายการรออนุมัติ (Requests)</h3>
                <div class="overflow-y-auto max-h-[400px]">
                    <table class="w-full text-left text-sm">
                        <tbody id="list-reqs">
                            <tr><td class="p-4 text-center text-slate-500">รอโหลด...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="glass-card p-6">
                <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-2">
                    <h3 class="font-bold text-xl">ห้องเกม (Rooms)</h3>
                    <button onclick="Admin.createRoom()" class="bg-blue-600 px-3 py-1 rounded text-xs font-bold">+ สร้างห้อง</button>
                </div>
                <div id="list-rooms" class="space-y-3 max-h-[400px] overflow-y-auto">
                    <div class="text-center text-slate-500 p-4">รอโหลด...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAHAkBhypqyJuuL22tLrFKN7ZqdEsqGDTk", authDomain: "rsdm-9ca2a.firebaseapp.com", projectId: "rsdm-9ca2a", storageBucket: "rsdm-9ca2a.firebasestorage.app", messagingSenderId: "299212700124", appId: "1:299212700124:web:730160dae6bb1b09cbb719" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); 
        const db = firebase.firestore();

        // --- DIAGNOSTIC TOOL (ตัวเช็คปัญหา) ---
        function checkConnection() {
            const statusBox = document.getElementById('db-status');
            // Try to read a non-existent doc just to check connection/rules
            db.collection('_test_connectivity').doc('ping').get()
            .then(() => {
                statusBox.innerHTML = '<i class="fa-solid fa-check-circle mr-2"></i> เชื่อมต่อ Firebase สำเร็จ (OK)';
                statusBox.className = 'fixed top-2 right-2 z-[9999] bg-green-900/90 text-green-200 border border-green-500 px-4 py-2 rounded shadow-lg font-bold';
                setTimeout(() => statusBox.style.display = 'none', 5000);
            })
            .catch((error) => {
                let msg = "เชื่อมต่อไม่ได้!";
                if(error.code === 'permission-denied') msg = "ติด Permission (แก้ Rules ข้อ 2)";
                else if(error.code === 'unavailable') msg = "เน็ตหลุด / หรือยังไม่สร้าง Database";
                
                statusBox.innerHTML = `<i class="fa-solid fa-triangle-exclamation mr-2"></i> Error: ${msg} <br><span class="text-xs font-normal">${error.code}</span>`;
                statusBox.className = 'fixed top-2 right-2 z-[9999] bg-red-900/90 text-red-200 border border-red-500 px-4 py-2 rounded shadow-lg font-bold animate-pulse';
            });
        }
        checkConnection();

        // --- ADMIN LOGIC ---
        const Admin = {
            login: () => {
                auth.signInWithEmailAndPassword(document.getElementById('a-email').value, document.getElementById('a-pass').value)
                .catch(err => Swal.fire('Login Error', err.message, 'error'));
            },
            
            fixData: async () => {
                try {
                    await db.collection('config').doc('settings').set({isOpen:true, siteName:'ZONE.'}, {merge:true});
                    await db.collection('rooms').add({roomName: 'ห้องทดสอบ', betAmount:0, gameType:'xo', players:[], createdAt: new Date()});
                    Swal.fire('สำเร็จ', 'สร้างข้อมูลตัวอย่างแล้ว', 'success');
                } catch(e) { Swal.fire('Error', e.message, 'error'); }
            },

            loadData: () => {
                // 1. Rooms
                db.collection('rooms').onSnapshot(snap => {
                    document.getElementById('stat-rooms').innerText = snap.size;
                    const list = document.getElementById('list-rooms');
                    if(snap.empty) { list.innerHTML = '<div class="text-center text-slate-500 p-4">ไม่มีห้อง (กดปุ่มสร้าง)</div>'; return; }
                    list.innerHTML = snap.docs.map(d => {
                        const r = d.data();
                        return `<div class="bg-white/5 p-4 rounded-xl flex justify-between items-center border-l-4 border-purple-500">
                            <div><div class="font-bold">${r.roomName}</div><div class="text-xs text-slate-400">Bet: ${r.betAmount}</div></div>
                            <button onclick="db.collection('rooms').doc('${d.id}').delete()" class="text-red-400 hover:text-red-300"><i class="fa-solid fa-trash"></i></button>
                        </div>`;
                    }).join('');
                });

                // 2. Users
                db.collection('users').onSnapshot(snap => document.getElementById('stat-users').innerText = snap.size);

                // 3. Requests (Client-side Sort to prevent Index Error)
                db.collection('requests').onSnapshot(snap => {
                    const all = snap.docs.map(d => ({id:d.id, ...d.data()}));
                    const pending = all.filter(r => r.status === 'pending');
                    document.getElementById('stat-reqs').innerText = pending.length;
                    
                    const list = document.getElementById('list-reqs');
                    if(pending.length === 0) { list.innerHTML = '<tr><td class="p-4 text-center text-slate-500">ไม่มีรายการค้าง</td></tr>'; return; }
                    
                    list.innerHTML = pending.map(r => `
                        <tr class="border-b border-white/5 bg-white/5">
                            <td class="p-3">
                                <div>${r.nickname||r.uid}</div>
                                <div class="text-xs ${r.type=='deposit'?'text-green-400':'text-red-400'} uppercase font-bold">${r.type} ${r.amount}</div>
                            </td>
                            <td class="p-3 text-right">
                                <button onclick="Admin.approve('${r.id}','${r.uid}','${r.type}',${r.amount})" class="bg-green-600 px-3 py-1 rounded text-xs mr-2">อนุมัติ</button>
                                <button onclick="db.collection('requests').doc('${r.id}').update({status:'rejected'})" class="bg-red-600 px-3 py-1 rounded text-xs">ปัดตก</button>
                            </td>
                        </tr>
                    `).join('');
                });
            },

            approve: async (rid, uid, type, amt) => {
                const batch = db.batch();
                const uRef = db.collection('users').doc(uid);
                if(type === 'deposit') batch.update(uRef, {credit: firebase.firestore.FieldValue.increment(amt)});
                else batch.update(uRef, {credit: firebase.firestore.FieldValue.increment(-amt)});
                batch.update(db.collection('requests').doc(rid), {status:'approved'});
                batch.set(db.collection('transactions').doc(), {uid, type, amount: (type=='deposit'?amt:-amt), timestamp: new Date()});
                await batch.commit();
                Swal.fire('Approved', '', 'success');
            },

            createRoom: async () => {
                const { value: formValues } = await Swal.fire({
                    title: 'สร้างห้อง',
                    html: '<input id="swal-name" class="swal2-input" placeholder="ชื่อห้อง"><input id="swal-bet" type="number" class="swal2-input" placeholder="เดิมพัน">',
                    focusConfirm: false,
                    preConfirm: () => { return [document.getElementById('swal-name').value, document.getElementById('swal-bet').value] }
                });
                if(formValues && formValues[0]) {
                    db.collection('rooms').add({roomName: formValues[0], betAmount: parseInt(formValues[1])||0, gameType: 'xo', players: [], createdAt: new Date(), scores:{}, board: Array(9).fill(null), roundState: 'idle'});
                }
            }
        };

        auth.onAuthStateChanged(user => {
            if(user) {
                document.getElementById('view-login').style.display = 'none';
                document.getElementById('view-app').classList.remove('hidden');
                Admin.loadData();
            } else {
                document.getElementById('view-login').style.display = 'flex';
                document.getElementById('view-app').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
