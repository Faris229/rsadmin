<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Service Admin</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; color: #334155; }
        
        /* Sidebar */
        .sidebar { width: 260px; height: 100vh; background: #ffffff; border-right: 1px solid #e2e8f0; position: fixed; top: 0; left: 0; z-index: 50; display: flex; flex-direction: column; }
        
        /* Navigation */
        .nav-btn { display: flex; align-items: center; gap: 12px; padding: 14px 24px; margin: 4px 12px; color: #64748b; font-weight: 500; border-radius: 12px; transition: 0.2s; cursor: pointer; }
        .nav-btn:hover { background: #f1f5f9; color: #0f172a; }
        .nav-btn.active { background: #eff6ff; color: #2563eb; font-weight: 700; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.1); }
        
        /* Badges */
        .badge { background: #ef4444; color: white; font-size: 10px; padding: 2px 8px; border-radius: 20px; margin-left: auto; font-weight: bold; }
        
        /* Cards */
        .stat-card { background: white; padding: 24px; border-radius: 16px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .order-card { background: white; border: 1px solid #e2e8f0; border-radius: 16px; padding: 20px; transition: 0.2s; position: relative; overflow: hidden; margin-bottom: 16px; }
        .order-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: #cbd5e1; }
        
        /* Status Indicators */
        .status-line { position: absolute; left: 0; top: 0; bottom: 0; width: 5px; }
        .st-pending { background: #ef4444; } /* แดง - รอรับ */
        .st-working { background: #3b82f6; } /* ฟ้า - กำลังทำ */
        .st-testing { background: #8b5cf6; } /* ม่วง - ตรวจสอบ */
        .st-completed { background: #10b981; } /* เขียว - เสร็จ */
    </style>
</head>
<body class="bg-gray-50 pl-[260px]">

    <aside class="sidebar">
        <div class="h-24 flex items-center px-8 border-b border-gray-100">
            <h1 class="text-xl font-black text-slate-800 flex items-center gap-2">
                <i class="fa-solid fa-layer-group text-blue-600"></i> Admin Panel
            </h1>
        </div>
        
        <nav class="flex-1 py-6 space-y-1">
            <div onclick="App.renderDashboard()" id="menu-dash" class="nav-btn active">
                <i class="fa-solid fa-chart-pie w-5"></i> ภาพรวม (Dashboard)
            </div>
            <div onclick="App.renderOrders('pending')" id="menu-new" class="nav-btn">
                <i class="fa-solid fa-inbox w-5"></i> คำสั่งซื้อใหม่ 
                <span id="badge-new" class="badge hidden">0</span>
            </div>
            <div onclick="App.renderOrders('working')" id="menu-work" class="nav-btn">
                <i class="fa-solid fa-hammer w-5"></i> กำลังดำเนินการ
                <span id="badge-work" class="badge bg-blue-500 hidden">0</span>
            </div>
            <div onclick="App.renderHistory()" id="menu-hist" class="nav-btn">
                <i class="fa-solid fa-clock-rotate-left w-5"></i> ประวัติงาน (History)
            </div>
            <div onclick="App.renderUsers()" id="menu-user" class="nav-btn">
                <i class="fa-solid fa-users w-5"></i> จัดการลูกค้า
            </div>
        </nav>

        <div class="p-6 border-t border-gray-100">
            <div class="text-xs text-gray-400 font-bold uppercase mb-2">Logged in as</div>
            <div class="text-sm font-bold text-slate-700 truncate mb-4">faris@gmail.com</div>
            <button onclick="Auth.logout()" class="w-full py-2.5 text-sm text-red-600 font-bold bg-red-50 rounded-xl hover:bg-red-100 transition">
                <i class="fa-solid fa-sign-out-alt mr-2"></i> ออกจากระบบ
            </button>
        </div>
    </aside>

    <main class="min-h-screen flex flex-col">
        <header class="h-20 bg-white/80 backdrop-blur border-b border-gray-200 flex items-center justify-between px-10 sticky top-0 z-40">
            <h2 id="page-title" class="text-2xl font-bold text-slate-800">Dashboard</h2>
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                <span class="text-sm font-bold text-slate-500">System Online</span>
            </div>
        </header>

        <div id="content-area" class="p-10 flex-1">
            <div id="loading" class="flex flex-col items-center justify-center h-64 text-slate-400">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl mb-4"></i>
                <p>กำลังโหลดข้อมูล...</p>
            </div>
        </div>
    </main>

    <div id="login-modal" class="fixed inset-0 bg-slate-900/95 z-[100] flex items-center justify-center hidden">
        <div class="bg-white p-10 rounded-2xl w-full max-w-sm text-center shadow-2xl animate__animated animate__fadeInDown">
            <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl"><i class="fa-solid fa-lock"></i></div>
            <h2 class="text-2xl font-bold mb-2 text-slate-800">ผู้ดูแลระบบ</h2>
            <p class="text-slate-500 mb-8 text-sm">กรุณาเข้าสู่ระบบด้วยบัญชี faris@gmail.com</p>
            <input id="adm-pass" type="password" class="w-full p-4 border border-slate-200 rounded-xl mb-4 bg-slate-50 focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-100 outline-none transition" placeholder="รหัสผ่าน">
            <button onclick="Auth.login()" class="w-full py-4 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 hover:shadow-xl transition transform active:scale-95">เข้าสู่ระบบ</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAHAkBhypqyJuuL22tLrFKN7ZqdEsqGDTk",
            authDomain: "rsdm-9ca2a.firebaseapp.com",
            projectId: "rsdm-9ca2a",
            storageBucket: "rsdm-9ca2a.firebasestorage.app",
            messagingSenderId: "299212700124",
            appId: "1:299212700124:web:730160dae6bb1b09cbb719"
        };
        const SUPER_ADMIN = "faris@gmail.com"; 

        if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let allOrders = []; // เก็บข้อมูลทั้งหมดไว้ในตัวแปรเดียว เพื่อความลื่นไหล

        // --- AUTH ---
        const Auth = {
            login: () => {
                const pass = document.getElementById('adm-pass').value;
                auth.signInWithEmailAndPassword(SUPER_ADMIN, pass).catch(e => Swal.fire('ผิดพลาด', e.message, 'error'));
            },
            logout: () => auth.signOut().then(()=>location.reload())
        };

        // --- APP LOGIC ---
        const App = {
            init: () => {
                auth.onAuthStateChanged(user => {
                    if(user && user.email === SUPER_ADMIN) {
                        document.getElementById('login-modal').classList.add('hidden');
                        App.startDataListener();
                    } else {
                        document.getElementById('login-modal').classList.remove('hidden');
                    }
                });
            },

            // ดึงข้อมูล Realtime ทั้งหมดมาเก็บไว้ก่อน (แก้ปัญหา Loading)
            startDataListener: () => {
                db.collection('web_orders').orderBy('timestamp', 'desc').onSnapshot(snap => {
                    allOrders = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    document.getElementById('loading').classList.add('hidden');
                    
                    App.updateBadges();
                    
                    // Refresh หน้าปัจจุบัน
                    const activeMenu = document.querySelector('.nav-btn.active').id;
                    if(activeMenu === 'menu-dash') App.renderDashboard();
                    else if(activeMenu === 'menu-new') App.renderOrders('pending');
                    else if(activeMenu === 'menu-work') App.renderOrders('working');
                    else if(activeMenu === 'menu-hist') App.renderHistory();
                    else if(activeMenu === 'menu-user') App.renderUsers();
                }, error => {
                    console.error(error);
                    Swal.fire('Error', 'โหลดข้อมูลไม่สำเร็จ: ' + error.message, 'error');
                });
            },

            updateBadges: () => {
                const pending = allOrders.filter(o => o.status === 'pending').length;
                const working = allOrders.filter(o => ['working', 'testing'].includes(o.status)).length;
                
                const b1 = document.getElementById('badge-new');
                const b2 = document.getElementById('badge-work');
                
                if(pending>0) { b1.innerText=pending; b1.classList.remove('hidden'); } else b1.classList.add('hidden');
                if(working>0) { b2.innerText=working; b2.classList.remove('hidden'); } else b2.classList.add('hidden');
            },

            setActive: (id) => {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.getElementById(id).classList.add('active');
            },

            // --- 1. DASHBOARD VIEW ---
            renderDashboard: () => {
                App.setActive('menu-dash');
                document.getElementById('page-title').innerText = "ภาพรวมระบบ (Dashboard)";
                
                const total = allOrders.length;
                const pending = allOrders.filter(o => o.status === 'pending').length;
                const working = allOrders.filter(o => ['working','testing'].includes(o.status)).length;
                const completed = allOrders.filter(o => o.status === 'completed').length;

                const html = `
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="stat-card border-l-4 border-red-500">
                            <div class="text-xs font-bold text-gray-400 uppercase">ออเดอร์ใหม่</div>
                            <div class="text-4xl font-black text-slate-800 mt-2">${pending}</div>
                        </div>
                        <div class="stat-card border-l-4 border-blue-500">
                            <div class="text-xs font-bold text-gray-400 uppercase">กำลังทำ / QC</div>
                            <div class="text-4xl font-black text-slate-800 mt-2">${working}</div>
                        </div>
                        <div class="stat-card border-l-4 border-green-500">
                            <div class="text-xs font-bold text-gray-400 uppercase">เสร็จสิ้น</div>
                            <div class="text-4xl font-black text-slate-800 mt-2">${completed}</div>
                        </div>
                        <div class="stat-card border-l-4 border-slate-500">
                            <div class="text-xs font-bold text-gray-400 uppercase">รวมทั้งหมด</div>
                            <div class="text-4xl font-black text-slate-800 mt-2">${total}</div>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-bold text-slate-700 mb-4">รายการล่าสุด</h3>
                    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 border-b border-gray-200 text-xs font-bold text-gray-500 uppercase">
                                <tr>
                                    <th class="p-4">วันที่</th>
                                    <th class="p-4">ร้านค้า</th>
                                    <th class="p-4">ลูกค้า</th>
                                    <th class="p-4 text-center">สถานะ</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100 text-sm">
                                ${allOrders.slice(0,5).map(o => `
                                    <tr>
                                        <td class="p-4 text-gray-400">${new Date(o.timestamp?.toDate()).toLocaleDateString()}</td>
                                        <td class="p-4 font-bold text-blue-600">${o.shopName}</td>
                                        <td class="p-4">${o.customerName}</td>
                                        <td class="p-4 text-center"><span class="px-2 py-1 rounded text-xs font-bold text-white ${getStatusColor(o.status)}">${o.status.toUpperCase()}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                document.getElementById('content-area').innerHTML = html;
            },

            // --- 2. ORDER MANAGEMENT VIEW ---
            renderOrders: (tab) => {
                const mapId = tab === 'pending' ? 'menu-new' : 'menu-work';
                App.setActive(mapId);
                
                let filtered = [];
                let title = "";
                
                if(tab === 'pending') {
                    filtered = allOrders.filter(o => o.status === 'pending');
                    title = "คำสั่งซื้อใหม่ (New Orders)";
                } else {
                    filtered = allOrders.filter(o => ['working', 'testing'].includes(o.status));
                    title = "กำลังดำเนินการ (Work in Progress)";
                }
                
                document.getElementById('page-title').innerText = title;

                if(filtered.length === 0) {
                    document.getElementById('content-area').innerHTML = `<div class="text-center py-20 text-gray-400"><i class="fa-solid fa-box-open text-5xl mb-4"></i><br>ไม่มีงานในสถานะนี้</div>`;
                    return;
                }

                const html = `<div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                    ${filtered.map(o => `
                        <div class="order-card">
                            <div class="status-line ${getStatusColor(o.status)}"></div>
                            <div class="flex justify-between items-start mb-4">
                                <span class="bg-gray-100 text-gray-500 text-xs px-2 py-1 rounded font-bold">${new Date(o.timestamp?.toDate()).toLocaleDateString()}</span>
                                <span class="text-xs font-bold uppercase text-gray-400">${o.status}</span>
                            </div>
                            <h3 class="text-xl font-bold text-slate-800 mb-1">${o.shopName}</h3>
                            <p class="text-sm text-gray-500 mb-4 flex items-center gap-2"><i class="fa-solid fa-user"></i> ${o.customerName}</p>
                            
                            <div class="bg-slate-50 p-3 rounded-lg text-sm text-slate-600 space-y-1 mb-4 border border-slate-100">
                                <div class="flex justify-between"><span>Admin Email:</span> <span class="font-bold select-all">${o.adminEmail}</span></div>
                                <div class="flex justify-between"><span>Password:</span> <span class="font-bold select-all">${o.adminPass}</span></div>
                            </div>

                            <div class="space-y-2">
                                ${tab === 'pending' 
                                    ? `<button onclick="App.updateStatus('${o.id}', 'working')" class="w-full py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-sm">กดรับงาน (เริ่มทำ)</button>`
                                    : `<div class="grid grid-cols-2 gap-2">
                                         <button onclick="App.updateStatus('${o.id}', 'testing')" class="py-2 bg-purple-100 text-purple-700 rounded-lg font-bold hover:bg-purple-200">ตรวจสอบ (QC)</button>
                                         <button onclick="App.updateStatus('${o.id}', 'completed')" class="py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 shadow-sm">เสร็จสิ้น</button>
                                       </div>`
                                }
                            </div>
                        </div>
                    `).join('')}
                </div>`;
                document.getElementById('content-area').innerHTML = html;
            },

            // --- 3. HISTORY VIEW ---
            renderHistory: () => {
                App.setActive('menu-hist');
                document.getElementById('page-title').innerText = "ประวัติงานเสร็จสิ้น (History)";
                
                const finished = allOrders.filter(o => ['completed', 'cancelled'].includes(o.status));
                
                const html = `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 border-b border-gray-200 text-xs font-bold text-gray-500 uppercase">
                                <tr>
                                    <th class="p-4">วันที่</th>
                                    <th class="p-4">ร้านค้า</th>
                                    <th class="p-4">ลูกค้า</th>
                                    <th class="p-4 text-center">สถานะ</th>
                                    <th class="p-4 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100 text-sm">
                                ${finished.map(o => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="p-4 text-gray-400">${new Date(o.timestamp?.toDate()).toLocaleDateString()}</td>
                                        <td class="p-4 font-bold text-slate-800">${o.shopName}</td>
                                        <td class="p-4 text-slate-600">${o.customerName}</td>
                                        <td class="p-4 text-center"><span class="px-2 py-1 rounded text-xs font-bold text-white ${getStatusColor(o.status)}">${o.status.toUpperCase()}</span></td>
                                        <td class="p-4 text-right">
                                            <button onclick="App.deleteOrder('${o.id}')" class="text-red-400 hover:text-red-600 font-bold text-xs">ลบถาวร</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>`;
                document.getElementById('content-area').innerHTML = html;
            },

            // --- 4. USER MANAGEMENT VIEW ---
            renderUsers: () => {
                App.setActive('menu-user');
                document.getElementById('page-title').innerText = "จัดการข้อมูลลูกค้า";
                
                // Group users
                const users = {};
                allOrders.forEach(o => {
                    if(!users[o.uid]) users[o.uid] = { name: o.customerName, count: 0, last: o.timestamp };
                    users[o.uid].count++;
                });

                const html = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${Object.keys(users).map(uid => `
                            <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex items-center gap-4">
                                <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 text-xl font-bold">
                                    ${users[uid].name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h4 class="font-bold text-lg text-slate-800">${users[uid].name}</h4>
                                    <p class="text-sm text-gray-500">สั่งทำไปแล้ว <b class="text-blue-600">${users[uid].count}</b> เว็บ</p>
                                    <p class="text-xs text-gray-400 mt-1">ล่าสุด: ${new Date(users[uid].last?.toDate()).toLocaleDateString()}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
                document.getElementById('content-area').innerHTML = html;
            },

            // --- ACTIONS ---
            updateStatus: (id, status) => {
                db.collection('web_orders').doc(id).update({ status: status }).then(() => {
                    const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 1500});
                    Toast.fire({icon: 'success', title: 'อัปเดตสถานะสำเร็จ'});
                });
            },
            
            deleteOrder: (id) => {
                Swal.fire({
                    title: 'ยืนยันการลบ?', text: "ข้อมูลจะหายไปถาวร", icon: 'warning', 
                    showCancelButton: true, confirmButtonColor: '#ef4444'
                }).then((r) => {
                    if(r.isConfirmed) db.collection('web_orders').doc(id).delete();
                });
            }
        };

        function getStatusColor(s) {
            if(s==='pending') return 'st-pending';
            if(s==='working') return 'st-working';
            if(s==='testing') return 'st-testing';
            if(s==='completed') return 'st-completed';
            return 'bg-gray-400';
        }

        App.init();
    </script>
</body>
</html>
