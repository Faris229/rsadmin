<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Management</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Prompt', sans-serif; background: #f8f9fa; }
        .sidebar { width: 260px; height: 100vh; background: #fff; border-right: 1px solid #eee; position: fixed; top: 0; left: 0; display: flex; flex-direction: column; padding: 20px; }
        .main-content { margin-left: 260px; padding: 40px; }
        
        .stat-card { background: #fff; border-radius: 16px; padding: 24px; border: 1px solid #eee; }
        .table-container { background: #fff; border-radius: 16px; border: 1px solid #eee; overflow: hidden; margin-top: 30px; }
        
        .btn-status { font-size: 11px; font-weight: 700; text-transform: uppercase; padding: 6px 12px; border-radius: 6px; border: 1px solid #ddd; background: #fff; color: #666; cursor: pointer; transition: 0.2s; }
        .btn-status:hover { background: #f0f0f0; }
        .btn-status.active { background: #000; color: #fff; border-color: #000; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 100; }
        .modal-box { background: #fff; width: 100%; max-width: 500px; padding: 30px; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="login-overlay" class="fixed inset-0 bg-white z-[999] flex items-center justify-center">
        <div class="w-80 text-center">
            <h2 class="text-2xl font-bold mb-6">Admin Access</h2>
            <input id="adm-email" value="faris@gmail.com" class="w-full p-3 bg-gray-50 border rounded-lg mb-3 text-center" placeholder="Email">
            <input id="adm-pass" type="password" class="w-full p-3 bg-gray-50 border rounded-lg mb-4 text-center" placeholder="Password">
            <button onclick="AdminAuth.login()" class="w-full bg-black text-white py-3 rounded-lg font-bold">เข้าสู่ระบบ</button>
        </div>
    </div>

    <aside class="sidebar">
        <div class="font-bold text-2xl tracking-tighter mb-10 flex items-center gap-3">
            <i class="fa-solid fa-cube"></i> Admin.
        </div>
        <nav class="flex-1 space-y-2">
            <a href="#" class="block p-3 bg-black text-white rounded-lg font-bold"><i class="fa-solid fa-chart-pie mr-2"></i> ภาพรวม</a>
            <a href="#" onclick="UI.toggleAnncModal()" class="block p-3 text-gray-500 hover:bg-gray-50 rounded-lg font-bold"><i class="fa-solid fa-bullhorn mr-2"></i> ประกาศ</a>
        </nav>
        <button onclick="AdminAuth.logout()" class="text-red-500 font-bold text-sm text-left hover:underline">ออกจากระบบ</button>
    </aside>

    <div class="main-content">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold">Dashboard</h1>
                <p class="text-gray-400">ภาพรวมคำสั่งซื้อทั้งหมด</p>
            </div>
            <div class="bg-green-100 text-green-700 px-4 py-2 rounded-full text-xs font-bold flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div> Online
            </div>
        </header>

        <div class="grid grid-cols-4 gap-6">
            <div class="stat-card">
                <div class="text-xs font-bold text-gray-400 uppercase mb-2">งานใหม่ (Pending)</div>
                <div id="count-pending" class="text-4xl font-bold">0</div>
            </div>
            <div class="stat-card">
                <div class="text-xs font-bold text-gray-400 uppercase mb-2">กำลังทำ (Active)</div>
                <div id="count-active" class="text-4xl font-bold text-blue-600">0</div>
            </div>
            <div class="stat-card">
                <div class="text-xs font-bold text-gray-400 uppercase mb-2">เสร็จสิ้น (Done)</div>
                <div id="count-done" class="text-4xl font-bold text-green-600">0</div>
            </div>
            <div class="stat-card bg-black text-white border-black">
                <div class="text-xs font-bold text-gray-400 uppercase mb-2">รวมทั้งหมด</div>
                <div id="count-total" class="text-4xl font-bold">0</div>
            </div>
        </div>

        <div class="table-container">
            <table class="w-full text-left">
                <thead class="bg-gray-50 text-xs font-bold uppercase text-gray-500 border-b border-gray-100">
                    <tr>
                        <th class="p-5 pl-8">โปรเจกต์</th>
                        <th class="p-5">ลูกค้า</th>
                        <th class="p-5">สถานะ</th>
                        <th class="p-5">จัดการ</th>
                    </tr>
                </thead>
                <tbody id="table-body" class="divide-y divide-gray-100 text-sm">
                    <tr><td colspan="4" class="p-10 text-center text-gray-400">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="modal-manage" class="modal-overlay">
        <div class="modal-box">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl" id="m-shop">Shop Name</h3>
                <button onclick="UI.closeModal()" class="text-gray-400 hover:text-black"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase block mb-2">เปลี่ยนสถานะ</label>
                    <div class="flex flex-wrap gap-2" id="status-btns"></div>
                </div>

                <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                    <label class="text-xs font-bold text-gray-400 uppercase block mb-3"><i class="fa-solid fa-key"></i> ข้อมูลเข้าใช้งาน (ส่งให้ลูกค้า)</label>
                    <input id="m-user" class="w-full p-2 border rounded mb-2 text-sm" placeholder="Username / Email">
                    <input id="m-pass" class="w-full p-2 border rounded mb-2 text-sm" placeholder="Password">
                    <button onclick="AdminLogic.saveSecret()" class="w-full bg-black text-white py-2 rounded text-xs font-bold uppercase hover:opacity-80">บันทึกข้อมูลลับ</button>
                </div>

                <button onclick="AdminLogic.deleteOrder()" class="text-red-500 text-xs font-bold hover:underline">ลบคำสั่งซื้อนี้</button>
            </div>
        </div>
    </div>

    <div id="modal-annc" class="modal-overlay">
        <div class="modal-box">
            <h3 class="font-bold text-xl mb-4">ประกาศหน้าเว็บ</h3>
            <input id="annc-title" class="w-full p-3 border rounded-lg mb-3" placeholder="หัวข้อประกาศ">
            <textarea id="annc-msg" class="w-full p-3 border rounded-lg h-24 mb-3 resize-none" placeholder="รายละเอียด..."></textarea>
            <div class="flex items-center gap-2 mb-6">
                <input type="checkbox" id="annc-active"> <label for="annc-active" class="text-sm">แสดงผลทันที</label>
            </div>
            <div class="flex gap-2">
                <button onclick="UI.toggleAnncModal()" class="flex-1 py-3 bg-gray-100 rounded-lg font-bold">ปิด</button>
                <button onclick="AdminLogic.saveAnnc()" class="flex-1 py-3 bg-black text-white rounded-lg font-bold">บันทึก</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAHAkBhypqyJuuL22tLrFKN7ZqdEsqGDTk",
            authDomain: "rsdm-9ca2a.firebaseapp.com",
            projectId: "rsdm-9ca2a",
            storageBucket: "rsdm-9ca2a.firebasestorage.app",
            messagingSenderId: "299212700124",
            appId: "1:299212700124:web:730160dae6bb1b09cbb719"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentId = null;

        // AUTH
        const AdminAuth = {
            login: () => {
                const e = document.getElementById('adm-email').value;
                const p = document.getElementById('adm-pass').value;
                firebase.auth().signInWithEmailAndPassword(e, p).catch(err => alert(err.message));
            },
            logout: () => auth.signOut()
        };

        auth.onAuthStateChanged(user => {
            if(user && user.email === 'faris@gmail.com') {
                document.getElementById('login-overlay').classList.add('hidden');
                AdminLogic.loadData();
            } else {
                document.getElementById('login-overlay').classList.remove('hidden');
            }
        });

        // UI & LOGIC
        const UI = {
            openManager: (id, shop, status, u, p) => {
                currentId = id;
                document.getElementById('modal-manage').style.display = 'flex';
                document.getElementById('m-shop').innerText = shop;
                document.getElementById('m-user').value = u || '';
                document.getElementById('m-pass').value = p || '';
                
                // Gen Status Buttons
                const statuses = ['pending', 'working', 'testing', 'completed', 'cancelled'];
                const container = document.getElementById('status-btns');
                container.innerHTML = statuses.map(s => 
                    `<button onclick="AdminLogic.setStatus('${s}')" class="btn-status ${status === s ? 'active' : ''}">${s}</button>`
                ).join('');
            },
            closeModal: () => {
                document.getElementById('modal-manage').style.display = 'none';
                currentId = null;
            },
            toggleAnncModal: () => {
                const el = document.getElementById('modal-annc');
                el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
            }
        };

        const AdminLogic = {
            loadData: () => {
                db.collection('web_orders').orderBy('timestamp', 'desc').onSnapshot(snap => {
                    const tbody = document.getElementById('table-body');
                    let p=0, a=0, d=0;

                    if(snap.empty) { tbody.innerHTML = `<tr><td colspan="4" class="p-10 text-center">ไม่มีข้อมูล</td></tr>`; return; }
                    
                    tbody.innerHTML = snap.docs.map(doc => {
                        const data = doc.data();
                        
                        // Count Stats
                        if(data.status === 'pending') p++;
                        if(['working','testing'].includes(data.status)) a++;
                        if(data.status === 'completed') d++;

                        // Color
                        let color = 'bg-gray-100 text-gray-500';
                        if(data.status === 'working') color = 'bg-blue-100 text-blue-600';
                        if(data.status === 'completed') color = 'bg-green-100 text-green-600';
                        if(data.status === 'cancelled') color = 'bg-red-100 text-red-600';

                        return `
                            <tr class="hover:bg-gray-50">
                                <td class="p-5 pl-8 font-bold">${data.shopName}</td>
                                <td class="p-5 text-gray-500">${data.customerName}<br><span class="text-xs text-gray-300">${data.uid.slice(0,5)}...</span></td>
                                <td class="p-5"><span class="px-3 py-1 rounded text-xs font-bold uppercase ${color}">${data.status}</span></td>
                                <td class="p-5">
                                    <button onclick="UI.openManager('${doc.id}', '${data.shopName}', '${data.status}', '${data.adminEmail||''}', '${data.adminPass||''}')" class="bg-black text-white px-4 py-2 rounded font-bold text-xs hover:opacity-80">จัดการ</button>
                                </td>
                            </tr>
                        `;
                    }).join('');

                    document.getElementById('count-pending').innerText = p;
                    document.getElementById('count-active').innerText = a;
                    document.getElementById('count-done').innerText = d;
                    document.getElementById('count-total').innerText = snap.size;
                });
            },
            setStatus: async (s) => {
                if(!currentId) return;
                await db.collection('web_orders').doc(currentId).update({ status: s });
                // Refresh modal UI manually simply by re-opening or just leave it open to see update in background
                UI.closeModal(); // Close to show list update
            },
            saveSecret: async () => {
                if(!currentId) return;
                const u = document.getElementById('m-user').value;
                const p = document.getElementById('m-pass').value;
                await db.collection('web_orders').doc(currentId).update({ adminEmail: u, adminPass: p });
                alert('Saved!');
            },
            deleteOrder: async () => {
                if(confirm('Delete this order?')) {
                    await db.collection('web_orders').doc(currentId).delete();
                    UI.closeModal();
                }
            },
            saveAnnc: async () => {
                const t = document.getElementById('annc-title').value;
                const m = document.getElementById('annc-msg').value;
                const a = document.getElementById('annc-active').checked;
                await db.collection('system_announcements').doc('main').set({
                    title: t, message: m, isActive: a
                });
                alert('Updated Announcement');
                UI.toggleAnncModal();
            }
        };
    </script>
</body>
</html>
