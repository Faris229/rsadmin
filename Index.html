<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Game Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Prompt', sans-serif; background: #f9fafb; color: #1f2937; }
        .sidebar { width: 250px; background: white; height: 100vh; position: fixed; border-right: 1px solid #e5e7eb; padding: 20px; }
        .content { margin-left: 250px; padding: 30px; }
        .input-adm { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; margin-bottom: 10px; }
        .btn-adm { background: #000; color: #fff; padding: 10px 20px; border-radius: 8px; width: 100%; font-weight: bold; }
        .menu-item { display: block; padding: 12px; border-radius: 8px; color: #4b5563; transition: 0.2s; cursor: pointer; }
        .menu-item:hover, .menu-item.active { background: #000; color: #fff; }
    </style>
</head>
<body>

    <div id="login-view" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="w-80 text-center">
            <h2 class="text-2xl font-bold mb-4">Admin Access</h2>
            <input id="adm-email" value="faris@gmail.com" class="input-adm text-center" placeholder="Email">
            <input id="adm-pass" type="password" class="input-adm text-center" placeholder="Password">
            <button onclick="Admin.login()" class="btn-adm">เข้าสู่ระบบ</button>
        </div>
    </div>

    <div class="sidebar flex flex-col justify-between">
        <div>
            <div class="font-bold text-2xl mb-8 flex items-center gap-2"><i class="fa-solid fa-crown"></i> Admin.</div>
            <nav class="space-y-2">
                <a onclick="UI.tab('rooms')" id="tab-rooms" class="menu-item active"><i class="fa-solid fa-gamepad mr-2"></i> จัดการห้อง</a>
                <a onclick="UI.tab('users')" id="tab-users" class="menu-item"><i class="fa-solid fa-users mr-2"></i> ผู้เล่น/เครดิต</a>
                <a onclick="UI.tab('settings')" id="tab-settings" class="menu-item"><i class="fa-solid fa-sliders mr-2"></i> ตั้งค่าเว็บ</a>
            </nav>
        </div>
        <button onclick="auth.signOut()" class="text-red-500 font-bold text-left">Log Out</button>
    </div>

    <div class="content">
        <div id="view-rooms">
            <h2 class="text-2xl font-bold mb-6">สร้างห้องเกม</h2>
            <div class="bg-white p-6 rounded-xl border border-gray-200 grid grid-cols-2 gap-4 mb-8 shadow-sm">
                <input id="c-name" class="input-adm" placeholder="ชื่อห้อง">
                <input id="c-pass" class="input-adm" placeholder="รหัสผ่านห้อง">
                <select id="c-type" class="input-adm">
                    <option value="rps">เป่ายิ้งฉุบ (RPS)</option>
                    <option value="xo">เอ็กซ์โอ (XO)</option>
                </select>
                <div class="grid grid-cols-2 gap-4">
                    <input id="c-bet" type="number" class="input-adm" placeholder="เดิมพัน">
                    <input id="c-win" type="number" class="input-adm" placeholder="ชนะกี่ตา" value="3">
                </div>
                <button onclick="Admin.createRoom()" class="btn-adm col-span-2">สร้างห้อง</button>
            </div>
            
            <h3 class="font-bold mb-4 text-lg">ห้องที่เปิดอยู่</h3>
            <div id="room-list" class="grid grid-cols-2 gap-4"></div>
        </div>

        <div id="view-users" class="hidden">
            <h2 class="text-2xl font-bold mb-6">จัดการเครดิตผู้เล่น</h2>
            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 border-b">
                        <tr><th class="p-4">User</th><th class="p-4">Credit</th><th class="p-4">Manage</th></tr>
                    </thead>
                    <tbody id="user-list"></tbody>
                </table>
            </div>
        </div>

        <div id="view-settings" class="hidden">
            <h2 class="text-2xl font-bold mb-6">ตั้งค่าระบบเว็บ</h2>
            <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm max-w-2xl space-y-4">
                
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border">
                    <div>
                        <div class="font-bold">สถานะเว็บไซต์</div>
                        <div class="text-xs text-gray-500">ปิดเพื่อปรับปรุงระบบ (ลูกค้าจะเข้าไม่ได้)</div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="set-status" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                    </label>
                </div>

                <div>
                    <label class="font-bold text-sm">ชื่อเว็บไซต์</label>
                    <input id="set-name" class="input-adm" placeholder="เช่น Game Zone 888">
                </div>
                <div>
                    <label class="font-bold text-sm">ลิงก์ Facebook (สำหรับติดต่อ)</label>
                    <input id="set-fb" class="input-adm" placeholder="https://m.me/...">
                </div>
                <div>
                    <label class="font-bold text-sm">กฎกติกา (แสดงหน้าแรก)</label>
                    <textarea id="set-rules" class="input-adm h-32" placeholder="ใส่กฎการเล่น..."></textarea>
                </div>
                
                <button onclick="Admin.saveSettings()" class="btn-adm bg-blue-600 hover:bg-blue-700">บันทึกการตั้งค่า</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAHAkBhypqyJuuL22tLrFKN7ZqdEsqGDTk",
            authDomain: "rsdm-9ca2a.firebaseapp.com",
            projectId: "rsdm-9ca2a",
            storageBucket: "rsdm-9ca2a.firebasestorage.app",
            messagingSenderId: "299212700124",
            appId: "1:299212700124:web:730160dae6bb1b09cbb719"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const UI = {
            tab: (id) => {
                ['rooms','users','settings'].forEach(t => {
                    document.getElementById(`view-${t}`).classList.add('hidden');
                    document.getElementById(`tab-${t}`).classList.remove('active');
                });
                document.getElementById(`view-${id}`).classList.remove('hidden');
                document.getElementById(`tab-${id}`).classList.add('active');
            }
        };

        const Admin = {
            login: () => {
                const e = document.getElementById('adm-email').value;
                const p = document.getElementById('adm-pass').value;
                auth.signInWithEmailAndPassword(e, p).catch(e => alert(e.message));
            },
            createRoom: () => {
                const name = document.getElementById('c-name').value;
                const pass = document.getElementById('c-pass').value;
                const type = document.getElementById('c-type').value;
                const bet = parseInt(document.getElementById('c-bet').value);
                const win = parseInt(document.getElementById('c-win').value);
                
                if(!name || !pass) return alert('กรอกข้อมูลให้ครบ');

                db.collection('rooms').add({
                    roomName: name, password: pass, gameType: type, betAmount: bet, maxWins: win,
                    players: [], status: 'waiting', scores: {}, board: Array(9).fill(null), moves: {},
                    roundState: 'idle', // For RPS timer
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('สร้างห้องสำเร็จ');
            },
            deleteRoom: (id) => db.collection('rooms').doc(id).delete(),
            manageCredit: (uid, amt) => db.collection('users').doc(uid).update({ credit: firebase.firestore.FieldValue.increment(amt) }),
            
            // Settings Logic
            loadSettings: () => {
                db.collection('config').doc('settings').onSnapshot(doc => {
                    if(doc.exists) {
                        const d = doc.data();
                        document.getElementById('set-name').value = d.siteName || '';
                        document.getElementById('set-fb').value = d.fbLink || '';
                        document.getElementById('set-rules').value = d.rules || '';
                        document.getElementById('set-status').checked = d.isOpen !== false; // Default true
                    }
                });
            },
            saveSettings: () => {
                db.collection('config').doc('settings').set({
                    siteName: document.getElementById('set-name').value,
                    fbLink: document.getElementById('set-fb').value,
                    rules: document.getElementById('set-rules').value,
                    isOpen: document.getElementById('set-status').checked
                }, { merge: true });
                alert('บันทึกการตั้งค่าแล้ว');
            }
        };

        // Init
        auth.onAuthStateChanged(user => {
            if(user && user.email === 'faris@gmail.com') {
                document.getElementById('login-view').classList.add('hidden');
                
                // Load Realtime Data
                db.collection('rooms').onSnapshot(snap => {
                    const el = document.getElementById('room-list');
                    el.innerHTML = snap.docs.map(doc => {
                        const r = doc.data();
                        return `<div class="bg-white p-4 rounded-lg border flex justify-between items-center">
                            <div><div class="font-bold">${r.roomName} (${r.gameType})</div><div class="text-xs text-gray-500">Pass: ${r.password} | Bet: ${r.betAmount}</div></div>
                            <button onclick="Admin.deleteRoom('${doc.id}')" class="text-red-500 font-bold text-xs">ลบ</button>
                        </div>`;
                    }).join('');
                });

                db.collection('users').onSnapshot(snap => {
                    const el = document.getElementById('user-list');
                    el.innerHTML = snap.docs.map(doc => {
                        const u = doc.data();
                        return `<tr class="border-b hover:bg-gray-50"><td class="p-4">${u.nickname}<br><span class="text-xs text-gray-400">${u.email}</span></td><td class="p-4 font-bold">${u.credit}</td><td class="p-4 flex gap-2"><button onclick="Admin.manageCredit('${doc.id}',100)" class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs">+100</button><button onclick="Admin.manageCredit('${doc.id}',-100)" class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs">-100</button></td></tr>`;
                    }).join('');
                });

                Admin.loadSettings();
            } else {
                document.getElementById('login-view').classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
